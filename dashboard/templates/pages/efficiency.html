{% extends "base.html" %}
{% block title %}Efficiency{% endblock %}

{% block content %}
<div x-data="efficiencyPage()" x-init="init()">

  <!-- Page Header -->
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
    <h1 class="page-title">Efficiency Report</h1>
    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      {% if latest_date %}
      <span style="font-size:12px; color:#888;">Latest data: {{ latest_date }}</span>
      {% endif %}
      <span x-show="uploadStatus" x-text="uploadStatus"
            :style="uploadError ? 'color:#e74c3c; font-size:13px;' : 'color:#27ae60; font-size:13px;'"></span>
      <label class="export-btn" x-show="activeTab === 'daily'" style="cursor:pointer; display:inline-flex; align-items:center; gap:6px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload Gusto CSV
        <input type="file" accept=".csv" style="display:none;" @change="uploadGusto($event)">
      </label>
      <button class="export-btn" @click="exportPdf()">Export PDF</button>
      <button class="export-btn" @click="export3dDesignPdf()" x-show="activeTab === 'noon' || activeTab === '3pm'">Export 3D Design PDF</button>
      <button class="export-btn" @click="openConstantsModal()" x-show="activeTab === 'noon' || activeTab === '3pm'">Edit Constants</button>
      <button class="export-btn" @click="openEmployeesModal()" x-show="activeTab === 'daily'">Edit Employees</button>
      <a class="export-btn" href="/efficiency/export/mm" x-show="activeTab === 'mm'" style="text-decoration:none;">Download CSV</a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="customer-tabs">
    <button class="customer-tab" :class="{ active: activeTab === 'daily' }" @click="activeTab = 'daily'">Daily EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === 'mm' }" @click="activeTab = 'mm'">MM EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === 'noon' }" @click="activeTab = 'noon'">Noon EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === '3pm' }" @click="activeTab = '3pm'">3PM EFF</button>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- DAILY EFF TAB                               -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'daily'">
    <!-- Filters -->
    <div class="customer-filters">
      <select class="filter-select" x-model="dailyDate">
        <option value="">All Dates</option>
        {% for d in available_dates %}
        <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
      <input type="text" class="search-input" placeholder="Search name, team..." x-model="dailySearch" style="flex:1; max-width:280px;">
      <select class="filter-select" x-model="dailyTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="clear-filters-btn" @click="clearDailyFilters()"
              x-show="dailySearch || dailyTeam || dailyDate !== {{ latest_date | tojson }}">Clear</button>
    </div>

    <!-- ALL Summary -->
    <template x-if="filteredDailyRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="dailySummaryAll().date"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().people"></td>
              <td style="text-align:center; font-weight:600;" :style="effColor(dailySummaryAll().eff)" x-text="dailySummaryAll().eff.toFixed(0) + '%'"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().cases"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().tasks"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().duration.toFixed(1)"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().hours.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="filteredDailyRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in dailySummaryTeams()" :key="'ts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:center; font-weight:600;" :style="effColor(ts.eff)" x-text="ts.eff > 0 ? ts.eff.toFixed(0) + '%' : ''"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
                <td style="text-align:right;" x-text="ts.hours.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Detail Sections (2-column grid) -->
    <div class="eff-team-grid">
      <template x-for="section in dailyTeamSections()" :key="'sec-'+section.team">
        <div style="margin-bottom:24px;">
          <div class="eff-section-label" x-text="section.team"></div>
          <table class="eff-table">
            <thead>
              <tr>
                <th>Group</th>
                <th>Name</th>
                <th style="text-align:center;">EFF</th>
                <th style="text-align:right;">Cases Worked On</th>
                <th style="text-align:right;">Tasks Completed</th>
                <th style="text-align:right;">Tasks Duration</th>
                <th style="text-align:right;">Work Hours</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'d-'+row.EmployeeID">
                <tr>
                  <td x-text="row.Team || ''"></td>
                  <td x-text="row['MT Name'] || ''" style="white-space:nowrap;"></td>
                  <td style="text-align:center; font-weight:600;" :style="effColor(row.Efficiency)" x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                  <td style="text-align:right;" x-text="row.Cases_Worked_On || 0"></td>
                  <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                  <td style="text-align:right;" x-text="(row.Tasks_Duration_Hours || 0).toFixed(1)"></td>
                  <td style="text-align:right;" x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>

    <!-- Training Section -->
    <template x-if="dailyTrainingRows().length > 0">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label">Training</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th>Name</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in dailyTrainingRows()" :key="'tr-'+row.EmployeeID">
              <tr>
                <td x-text="row.Team || ''"></td>
                <td x-text="row['MT Name'] || ''" style="white-space:nowrap;"></td>
                <td style="text-align:center; font-weight:600;" :style="effColor(row.Efficiency)" x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                <td style="text-align:right;" x-text="row.Cases_Worked_On || 0"></td>
                <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                <td style="text-align:right;" x-text="(row.Tasks_Duration_Hours || 0).toFixed(1)"></td>
                <td style="text-align:right;" x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <div x-show="filteredDailyRows().length === 0" style="text-align:center; padding:24px; color:#888;">
      No data — upload a Gusto CSV to get started
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- MM EFF TAB                                  -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'mm'">
    <div class="customer-filters">
      <select class="filter-select" x-model="mmTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="clear-filters-btn" @click="mmTeam=''" x-show="mmTeam">Clear</button>
    </div>

    <!-- Teams Summary Grid -->
    <template x-if="filteredMMRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label" x-text="dailyDate ? dailyDate : 'Multi-Period'"></div>
        <div class="mm-eff-wrap">
          <table class="eff-table">
            <thead>
              <tr>
                <th style="position:sticky; left:0; z-index:2; background:#2C2C2C;">Teams</th>
                {% for col in mm_eff_cols %}
                <th style="white-space:nowrap; text-align:right; font-size:11px;">{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="ts in mmTeamsSummary()" :key="'mmts-'+ts.team">
                <tr>
                  <td style="font-weight:600; white-space:nowrap; position:sticky; left:0; z-index:1; background:inherit;" x-text="ts.team"></td>
                  {% for col in mm_eff_cols %}
                  <td style="text-align:right; font-size:12px; font-weight:600;"
                      :style="mmEffColor(ts['{{ col }}'])"
                      x-text="formatMmEff(ts['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <!-- Per-Team Detail Sections -->
    <template x-for="section in mmTeamSections()" :key="'mmsec-'+section.team">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label" x-text="section.team"></div>
        <div class="mm-eff-wrap">
          <table class="eff-table">
            <thead>
              <tr>
                <th style="position:sticky; left:0; z-index:2; background:#2C2C2C; min-width:80px;">Team</th>
                <th style="position:sticky; left:80px; z-index:2; background:#2C2C2C; min-width:120px;">Name</th>
                {% for col in mm_eff_cols %}
                <th style="white-space:nowrap; text-align:right; font-size:11px;">{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'mm-'+row['MT Name']">
                <tr>
                  <td x-text="row.Team || ''" style="white-space:nowrap; position:sticky; left:0; z-index:1; background:inherit;"></td>
                  <td x-text="row['MT Name'] || ''" style="white-space:nowrap; position:sticky; left:80px; z-index:1; background:inherit;"></td>
                  {% for col in mm_eff_cols %}
                  <td style="text-align:right; font-size:12px; font-weight:600;"
                      :style="mmEffColor(row['{{ col }}'])"
                      x-text="formatMmEff(row['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <div x-show="filteredMMRows().length === 0" style="text-align:center; padding:24px; color:#888;">
      No aggregated data — upload a Gusto CSV to get started
    </div>
  </div>


  <!-- ═══════════════════════════════════════════ -->
  <!-- NOON EFF TAB                                -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'noon'">
    <div style="padding:8px 0 12px; color:#888; font-size:13px;">
      Snapshot: today 3:00 AM – 12:00 PM · Updated automatically at noon on business days
    </div>

    <!-- ALL Summary -->
    <template x-if="noonRows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="middaySummaryAll(noonRows).date"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).people"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).cases"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).tasks"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).duration.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="noonRows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Team/Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in middaySummaryTeams(noonRows)" :key="'nts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Details (2-column grid) -->
    <div class="eff-team-grid">
      <template x-for="section in middayTeamSections(noonRows)" :key="'nsec-'+section.team">
        <div style="margin-bottom:24px;">
          <div class="eff-section-label" x-text="section.team"></div>
          <table class="eff-table">
            <thead>
              <tr>
                <th>Group</th>
                <th>Name</th>
                <th style="text-align:right;">Cases Worked On</th>
                <th style="text-align:right;">Tasks Completed</th>
                <th style="text-align:right;">Tasks Duration</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'n-'+row.Name">
                <tr>
                  <td x-text="row.Team || ''"></td>
                  <td x-text="row.Name || ''" style="white-space:nowrap;"></td>
                  <td style="text-align:right;" :style="caseGoalColor(row.Cases, row.Noon_Goal)" x-text="row.Cases || 0"></td>
                  <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                  <td style="text-align:right;" x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>

    <div x-show="noonRows.length === 0" style="text-align:center; padding:24px; color:#888;">
      No noon data yet — updates automatically at 12:00 PM on business days
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- 3PM EFF TAB                                 -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === '3pm'">
    <div style="padding:8px 0 12px; color:#888; font-size:13px;">
      Snapshot: today 3:00 AM – 3:00 PM · Updated automatically at 3:00 PM on business days
    </div>

    <!-- ALL Summary -->
    <template x-if="pm3Rows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="middaySummaryAll(pm3Rows).date"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).people"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).cases"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).tasks"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).duration.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="pm3Rows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Team/Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in middaySummaryTeams(pm3Rows)" :key="'pts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Details (2-column grid) -->
    <div class="eff-team-grid">
      <template x-for="section in middayTeamSections(pm3Rows)" :key="'psec-'+section.team">
        <div style="margin-bottom:24px;">
          <div class="eff-section-label" x-text="section.team"></div>
          <table class="eff-table">
            <thead>
              <tr>
                <th>Group</th>
                <th>Name</th>
                <th style="text-align:right;">Cases Worked On</th>
                <th style="text-align:right;">Tasks Completed</th>
                <th style="text-align:right;">Tasks Duration</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'p-'+row.Name">
                <tr>
                  <td x-text="row.Team || ''"></td>
                  <td x-text="row.Name || ''" style="white-space:nowrap;"></td>
                  <td style="text-align:right;" :style="caseGoalColor(row.Cases, row.PM3_Goal)" x-text="row.Cases || 0"></td>
                  <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                  <td style="text-align:right;" x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>

    <div x-show="pm3Rows.length === 0" style="text-align:center; padding:24px; color:#888;">
      No 3PM data yet — updates automatically at 3:00 PM on business days
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- EDIT CONSTANTS MODAL                       -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="showConstantsModal" x-cloak
       style="position:fixed; inset:0; z-index:1000; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5);"
       @click.self="showConstantsModal = false">
    <div style="background:#fff; border-radius:8px; padding:24px; max-width:800px; width:95%; max-height:85vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3 style="margin:0; color:#1A1A1A;">Edit Tech Constants</h3>
        <button @click="showConstantsModal = false" style="background:none; border:none; font-size:20px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <table class="eff-table" style="font-size:12px;">
        <thead>
          <tr>
            <th>Name</th>
            <th style="width:70px;">Noon</th>
            <th style="width:70px;">3PM</th>
            <th style="width:110px;">Shift Type</th>
            <th style="width:100px;">Design Type</th>
            <th style="width:40px;"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in constantsData" :key="'ce-'+idx">
            <tr>
              <td><input type="text" x-model="row.Name" style="width:100%; border:1px solid #ddd; padding:2px 4px; font-size:12px;"></td>
              <td><input type="text" x-model="row.Noon" style="width:100%; border:1px solid #ddd; padding:2px 4px; font-size:12px; text-align:center;"></td>
              <td><input type="text" x-model="row['3PM']" style="width:100%; border:1px solid #ddd; padding:2px 4px; font-size:12px; text-align:center;"></td>
              <td>
                <select x-model="row.ShiftType" style="width:100%; border:1px solid #ddd; padding:2px 4px; font-size:12px;">
                  <option value="Morning">Morning</option>
                  <option value="Evening">Evening</option>
                  <option value="Outsource">Outsource</option>
                </select>
              </td>
              <td>
                <select x-model="row.DesignType" style="width:100%; border:1px solid #ddd; padding:2px 4px; font-size:12px;">
                  <option value="Regular">Regular</option>
                  <option value="Marpe">Marpe</option>
                </select>
              </td>
              <td style="text-align:center;">
                <button @click="constantsData.splice(idx, 1)" style="background:none; border:none; color:#C0392B; cursor:pointer; font-size:14px;" title="Remove">&times;</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button @click="constantsData.push({Name:'', Noon:'0', '3PM':'0', ShiftType:'Morning', DesignType:'Regular'})"
                class="export-btn" style="background:#2196F3;">+ Add Row</button>
        <button @click="saveConstants()" class="export-btn" :disabled="constantsSaving"
                x-text="constantsSaving ? 'Saving...' : 'Save Constants'"></button>
        <button @click="showConstantsModal = false" class="export-btn" style="background:#999;">Cancel</button>
      </div>
      <p x-show="constantsError" x-text="constantsError" style="color:#C0392B; margin-top:8px; font-size:13px;"></p>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- EDIT EMPLOYEES MODAL                       -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="showEmployeesModal" x-cloak
       style="position:fixed; inset:0; z-index:1000; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5);"
       @click.self="showEmployeesModal = false">
    <div style="background:#fff; border-radius:8px; padding:24px; max-width:1100px; width:95%; max-height:85vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0; color:#1A1A1A;">Edit Employees</h3>
        <button @click="showEmployeesModal = false" style="background:none; border:none; font-size:20px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <div style="margin-bottom:10px;">
        <input type="text" x-model="employeesFilter" placeholder="Filter by name, team, department..."
               style="width:300px; padding:6px 10px; border:1px solid #ccc; border-radius:4px; font-size:13px;">
      </div>
      <table class="eff-table" style="font-size:11px;">
        <thead>
          <tr>
            <th style="width:55px;">Emp ID</th>
            <th>Last Name</th>
            <th>First Name</th>
            <th>MT Name</th>
            <th>Department</th>
            <th>Gusto Name</th>
            <th style="width:110px;">Team</th>
            <th style="width:55px;">Training</th>
            <th style="width:30px;"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in filteredEmployees()" :key="'emp-'+idx">
            <tr>
              <td><input type="text" x-model="row['Employee ID']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px; text-align:center;"></td>
              <td><input type="text" x-model="row['Last Name']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td><input type="text" x-model="row['First Name']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td><input type="text" x-model="row['MT Name']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td><input type="text" x-model="row.Department" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td><input type="text" x-model="row['Gusto Name']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td><input type="text" x-model="row.Team" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;"></td>
              <td>
                <select x-model="row['Training Plan']" style="width:100%; border:1px solid #ddd; padding:2px 3px; font-size:11px;">
                  <option value="0">0</option>
                  <option value="1">1</option>
                </select>
              </td>
              <td style="text-align:center;">
                <button @click="employeesData.splice(employeesData.indexOf(row), 1)" style="background:none; border:none; color:#C0392B; cursor:pointer; font-size:14px;" title="Remove">&times;</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button @click="employeesData.push({'Employee ID':'', 'Last Name':'', 'First Name':'', 'MT Name':'', Department:'', 'Gusto Name':'', Team:'', 'Training Plan':'0'})"
                class="export-btn" style="background:#2196F3;">+ Add Row</button>
        <button @click="saveEmployees()" class="export-btn" :disabled="employeesSaving"
                x-text="employeesSaving ? 'Saving...' : 'Save Employees'"></button>
        <button @click="showEmployeesModal = false" class="export-btn" style="background:#999;">Cancel</button>
      </div>
      <p x-show="employeesError" x-text="employeesError" style="color:#C0392B; margin-top:8px; font-size:13px;"></p>
    </div>
  </div>

</div><!-- end x-data -->

<style>
  .eff-section-label {
    font-size: 14px;
    font-weight: 700;
    color: #C0392B;
    padding: 8px 0 4px;
    letter-spacing: 0.03em;
  }
  .eff-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 4px;
  }
  .eff-table thead th {
    background: #2C2C2C;
    color: #FFFFFF;
    padding: 6px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    white-space: nowrap;
    border-bottom: 1px solid #E0E0E0;
  }
  .eff-table tbody td {
    padding: 4px 10px;
    border-bottom: 1px solid #E0E0E0;
    font-size: 13px;
    color: #1A1A1A;
  }
  .eff-table tbody tr {
    background: #FFFFFF;
  }
  .eff-table tbody tr:nth-child(even) {
    background: #FAFAFA;
  }
  .eff-table tbody tr:hover {
    background: #F0F0F0;
  }
  .eff-team-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  @media (max-width: 900px) {
    .eff-team-grid {
      grid-template-columns: 1fr;
    }
  }
  .mm-eff-wrap {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 70vh;
    background: #FFFFFF;
  }
  .mm-eff-wrap table {
    width: 100%;
    min-width: unset;
  }
  .mm-eff-wrap th {
    position: sticky;
    top: 0;
    z-index: 2;
  }
  [x-cloak] { display: none !important; }
</style>

<script>
function efficiencyPage() {
  return {
    activeTab: 'daily',

    // Daily EFF state
    dailyRows: {{ daily_records | tojson }},
    dailyDate: {{ latest_date | tojson }},
    dailySearch: '',
    dailyTeam: '',

    // MM EFF state
    mmRows: {{ agg_records | tojson }},
    mmTeam: '',

    // Midday state
    noonRows: {{ noon_records | tojson }},
    pm3Rows: {{ pm3_records | tojson }},

    // Constants state
    constantsRecords: {{ constants_records | tojson }},
    showConstantsModal: false,
    constantsData: [],
    constantsSaving: false,
    constantsError: '',

    // Employees state
    showEmployeesModal: false,
    employeesData: [],
    employeesSaving: false,
    employeesError: '',
    employeesFilter: '',

    // Upload state
    uploadStatus: '',
    uploadError: false,

    // Efficiency column names for MM
    mmEffCols: {{ mm_eff_cols | tojson }},

    init() {},

    // ─── Daily EFF ───────────────────────────────
    filteredDailyRows() {
      let rows = this.dailyRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.dailyDate) rows = rows.filter(r => String(r.Date || '').startsWith(this.dailyDate));
      if (this.dailyTeam) rows = rows.filter(r => r.Team === this.dailyTeam);
      if (this.dailySearch.trim()) {
        const q = this.dailySearch.trim().toLowerCase();
        rows = rows.filter(r =>
          String(r['MT Name'] || '').toLowerCase().includes(q) ||
          String(r.Team || '').toLowerCase().includes(q)
        );
      }
      return rows;
    },

    dailySummaryAll() {
      const rows = this.filteredDailyRows();
      if (!rows.length) return { date: '', people: 0, eff: 0, cases: 0, tasks: 0, duration: 0, hours: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
      const hours = rows.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
      const eff = hours > 0 ? (duration / hours) * 100 : 0;
      const date = this.dailyDate || (rows[0] ? rows[0].Date : '');
      return { date, people, eff, cases, tasks, duration, hours };
    },

    dailySummaryTeams() {
      const rows = this.filteredDailyRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const cases = tr.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
        const tasks = tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
        const duration = tr.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
        const hours = tr.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
        const eff = hours > 0 ? (duration / hours) * 100 : 0;
        return { team, people: tr.length, eff, cases, tasks, duration, hours };
      });
    },

    dailyTeamSections() {
      const rows = this.filteredDailyRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0))
      }));
    },

    dailyTrainingRows() {
      return this.filteredDailyRows()
        .filter(r => r['Training Plan'] == 1)
        .sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0));
    },

    clearDailyFilters() {
      this.dailyDate = {{ latest_date | tojson }};
      this.dailySearch = '';
      this.dailyTeam = '';
    },

    effColor(val) {
      const n = Number(val) || 0;
      if (n >= 80) return 'color: #27AE60;';
      if (n >= 50) return '';
      if (n > 0) return 'color: #C0392B;';
      return 'color: #999;';
    },

    // ─── MM EFF ──────────────────────────────────
    filteredMMRows() {
      let rows = this.mmRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.mmTeam) rows = rows.filter(r => r.Team === this.mmTeam);
      return rows;
    },

    mmTeamsSummary() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      const effCols = this.mmEffCols;
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const summary = { team };
        effCols.forEach(col => {
          // Average non-"x" values
          const vals = tr.map(r => r[col]).filter(v => v !== 'x' && v !== null && v !== undefined && !isNaN(Number(v)));
          summary[col] = vals.length > 0 ? vals.reduce((s, v) => s + Number(v), 0) / vals.length : 'x';
        });
        return summary;
      });
    },

    mmTeamSections() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a['MT Name'] || '').localeCompare(String(b['MT Name'] || '')))
      }));
    },

    mmEffColor(val) {
      if (val === 'x' || val === null || val === undefined) return 'color:#999;';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'color:#999;';
      if (n >= 0.80) return 'color:#27AE60;';
      if (n >= 0.50) return '';
      return 'color:#C0392B;';
    },

    formatMmEff(val) {
      if (val === 'x') return '';
      if (val === null || val === undefined || val === 0) return '';
      const n = Number(val);
      if (isNaN(n)) return '';
      return (n * 100).toFixed(0) + '%';
    },

    // ─── Midday ──────────────────────────────────
    middaySummaryAll(rows) {
      if (!rows.length) return { date: '', people: 0, cases: 0, tasks: 0, duration: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0);
      const date = (rows[0] && rows[0].Data_Date) ? rows[0].Data_Date : new Date().toISOString().slice(0, 10);
      return { date, people, cases, tasks, duration };
    },

    middaySummaryTeams(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        return {
          team,
          people: tr.length,
          cases: tr.reduce((s, r) => s + (Number(r.Cases) || 0), 0),
          tasks: tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0),
          duration: tr.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0),
        };
      });
    },

    middayTeamSections(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a.Name || '').localeCompare(String(b.Name || '')))
      }));
    },

    // ─── Goal Color ──────────────────────────────
    caseGoalColor(actual, goal) {
      if (goal === null || goal === undefined || goal === 'NA' || goal === '') return '';
      const g = Number(goal);
      if (isNaN(g) || g === 0) return '';
      return Number(actual) >= g ? 'color:#27AE60; font-weight:600;' : 'color:#C0392B; font-weight:600;';
    },

    // ─── Constants Modal ─────────────────────────
    async openConstantsModal() {
      this.constantsError = '';
      this.constantsSaving = false;
      try {
        const resp = await fetch('/efficiency/constants');
        this.constantsData = await resp.json();
      } catch (e) {
        this.constantsData = JSON.parse(JSON.stringify(this.constantsRecords));
      }
      this.showConstantsModal = true;
    },

    async saveConstants() {
      this.constantsSaving = true;
      this.constantsError = '';
      try {
        const resp = await fetch('/efficiency/constants', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.constantsData),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.showConstantsModal = false;
          setTimeout(() => window.location.reload(), 500);
        } else {
          this.constantsError = data.message || 'Save failed';
        }
      } catch (e) {
        this.constantsError = 'Save failed — check console';
      }
      this.constantsSaving = false;
    },

    // ─── Employees Modal ────────────────────────
    filteredEmployees() {
      if (!this.employeesFilter.trim()) return this.employeesData;
      const q = this.employeesFilter.trim().toLowerCase();
      return this.employeesData.filter(r =>
        Object.values(r).some(v => String(v || '').toLowerCase().includes(q))
      );
    },

    async openEmployeesModal() {
      this.employeesError = '';
      this.employeesSaving = false;
      this.employeesFilter = '';
      try {
        const resp = await fetch('/efficiency/employees');
        this.employeesData = await resp.json();
      } catch (e) {
        this.employeesData = [];
        this.employeesError = 'Failed to load employees';
      }
      this.showEmployeesModal = true;
    },

    async saveEmployees() {
      this.employeesSaving = true;
      this.employeesError = '';
      try {
        const resp = await fetch('/efficiency/employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.employeesData),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.showEmployeesModal = false;
          setTimeout(() => window.location.reload(), 500);
        } else {
          this.employeesError = data.message || 'Save failed';
        }
      } catch (e) {
        this.employeesError = 'Save failed — check console';
      }
      this.employeesSaving = false;
    },

    // ─── Upload ──────────────────────────────────
    async uploadGusto(event) {
      const file = event.target.files[0];
      if (!file) return;
      this.uploadStatus = 'Uploading...';
      this.uploadError = false;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const resp = await fetch('/efficiency/upload', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Uploaded ${data.date_range} — ${data.new_rows} employees processed`;
          this.uploadError = false;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Upload failed — check console';
        this.uploadError = true;
      }
      event.target.value = '';
    },

    // ─── Refresh Midday ──────────────────────────
    async refreshMidday() {
      this.uploadStatus = 'Refreshing midday data...';
      this.uploadError = false;
      try {
        const resp = await fetch('/efficiency/refresh-midday', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Midday refreshed — noon: ${data.rows.noon} rows, 3pm: ${data.rows['3pm']} rows`;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Refresh failed — check console';
        this.uploadError = true;
      }
    },

    // ─── PDF Helpers ──────────────────────────────
    _pdfEffStyle(val) {
      const n = Number(val) || 0;
      if (n >= 80) return 'color:#27AE60; font-weight:600;';
      if (n >= 50) return 'font-weight:600;';
      if (n > 0) return 'color:#C0392B; font-weight:600;';
      return 'color:#999;';
    },

    _pdfMmEffStyle(val) {
      if (val === 'x' || val === null || val === undefined) return 'color:#999;';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'color:#999;';
      if (n >= 0.80) return 'color:#27AE60; font-weight:600;';
      if (n >= 0.50) return 'font-weight:600;';
      return 'color:#C0392B; font-weight:600;';
    },

    _pdfEffCell(val) {
      if (!val || val <= 0) return '';
      const pct = val.toFixed(0);
      return `<span style="${this._pdfEffStyle(val)}">${pct}%</span>`;
    },

    _pdfMmEffCell(val) {
      const text = this.formatMmEff(val);
      return `<span style="${this._pdfMmEffStyle(val)}">${text}</span>`;
    },

    // ─── PDF Export ──────────────────────────────
    async exportPdf() {
      const tabNames = { daily: 'Daily_EFF', mm: 'MM_EFF', noon: 'Noon_EFF', '3pm': '3PM_EFF' };
      const tabLabel = tabNames[this.activeTab] || 'Efficiency';
      const today = new Date().toISOString().slice(0, 10);

      // Determine report date from data (not today)
      let reportDate = today;
      if (this.activeTab === 'daily') {
        reportDate = this.dailySummaryAll().date || today;
      } else if (this.activeTab === 'noon' || this.activeTab === '3pm') {
        const src = this.activeTab === 'noon' ? this.noonRows : this.pm3Rows;
        reportDate = this.middaySummaryAll(src).date || today;
      }

      const filename = `Efficiency_${tabLabel}_${reportDate}.pdf`;

      // Load logo as base64
      let logoBase64 = '';
      try {
        const resp = await fetch('/static/logo.png');
        const blob = await resp.blob();
        logoBase64 = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (e) { /* logo optional */ }

      let html = `<div style="font-family:Arial,sans-serif; padding:8px;">`;

      // Logo + header
      if (logoBase64) {
        html += `<div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">`;
        html += `<img src="${logoBase64}" style="max-height:40px;">`;
        html += `<h2 style="margin:0; color:#000; font-size:14px;">${tabLabel.replace(/_/g,' ')} — ${reportDate}</h2>`;
        html += `</div>`;
      } else {
        html += `<h2 style="margin:0 0 8px; color:#000; font-size:14px;">${tabLabel.replace(/_/g,' ')} — ${reportDate}</h2>`;
      }

      if (this.activeTab === 'daily') {
        const summary = this.dailySummaryAll();

        // ALL table (full-width)
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">ALL</p>`;
        html += this._pdfTable(
          ['Date','People','EFF','Cases','Tasks','Duration','Work Hrs'],
          [[summary.date, summary.people, this._pdfEffCell(summary.eff), summary.cases, summary.tasks, summary.duration.toFixed(1), summary.hours.toFixed(1)]]
        );

        // Teams table (full-width)
        html += `<p style="margin:8px 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams</p>`;
        const teamRows = this.dailySummaryTeams().map(ts => [
          ts.team, ts.people, this._pdfEffCell(ts.eff), ts.cases, ts.tasks, ts.duration.toFixed(1), ts.hours.toFixed(1)
        ]);
        html += this._pdfTable(['Group','People','EFF','Cases','Tasks','Duration','Work Hrs'], teamRows);

        // Per-team (2-column grid)
        const sections = this.dailyTeamSections();
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px;">`;
        sections.forEach(sec => {
          html += `<div style="page-break-inside:avoid;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [
            r['MT Name'] || '', this._pdfEffCell(r.Efficiency),
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Name','EFF','Cases','Tasks','Duration','Work Hrs'], rows);
          html += `</div>`;
        });
        html += `</div>`;

        // Training (half-width)
        const trainRows = this.dailyTrainingRows();
        if (trainRows.length) {
          html += `<div style="max-width:50%; margin-top:6px;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">Training</p>`;
          const rows = trainRows.map(r => [
            r['MT Name'] || '', this._pdfEffCell(r.Efficiency),
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Name','EFF','Cases','Tasks','Duration','Work Hrs'], rows);
          html += `</div>`;
        }

      } else if (this.activeTab === 'mm') {
        const effCols = this.mmEffCols;
        const headers = ['Teams', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];

        // Teams summary (full-width)
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams Summary</p>`;
        const teamRows = this.mmTeamsSummary().map(ts => [ts.team, ...effCols.map(c => this._pdfMmEffCell(ts[c]))]);
        html += this._pdfMmTable(headers, teamRows);

        // Per-team (single column, full-width for many columns)
        const detailHeaders = ['Name', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];
        const sections = this.mmTeamSections();
        sections.forEach(sec => {
          html += `<div style="margin-top:4px;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [r['MT Name'] || '', ...effCols.map(c => this._pdfMmEffCell(r[c]))]);
          html += this._pdfMmTable(detailHeaders, rows);
          html += `</div>`;
        });

      } else {
        const isNoon = this.activeTab === 'noon';
        const src = isNoon ? this.noonRows : this.pm3Rows;
        const label = isNoon ? '12:00 PM' : '3:00 PM';

        const summary = this.middaySummaryAll(src);
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">ALL — ${label} Snapshot</p>`;
        html += this._pdfTable(
          ['Date','People','Cases','Tasks','Duration'],
          [[summary.date, summary.people, summary.cases, summary.tasks, summary.duration.toFixed(1)]]
        );

        html += `<p style="margin:8px 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams</p>`;
        const teamRows = this.middaySummaryTeams(src).map(ts => [ts.team, ts.people, ts.cases, ts.tasks, ts.duration.toFixed(1)]);
        html += this._pdfTable(['Team/Group','People','Cases','Tasks','Duration'], teamRows);

        // Per-team (2-column grid)
        const sections = this.middayTeamSections(src);
        const goalKey = isNoon ? 'Noon_Goal' : 'PM3_Goal';
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px;">`;
        sections.forEach(sec => {
          html += `<div style="page-break-inside:avoid;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => {
            const cases = r.Cases || 0;
            const goal = r[goalKey];
            let casesCell = String(cases);
            if (goal !== null && goal !== undefined && goal !== 'NA' && goal !== '' && !isNaN(Number(goal)) && Number(goal) > 0) {
              const color = Number(cases) >= Number(goal) ? '#27AE60' : '#C0392B';
              casesCell = `<span style="color:${color}; font-weight:600;">${cases}</span>`;
            }
            return [r.Name || '', casesCell, r.Tasks_Completed || 0, (r.Total_Duration_Hours || 0).toFixed(1)];
          });
          html += this._pdfTable(['Name','Cases','Tasks','Duration'], rows);
          html += `</div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;

      const opt = {
        margin: [5, 5, 5, 5],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: this.activeTab === 'mm' ? 1.5 : 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'landscape' },
        pagebreak: { mode: this.activeTab === 'mm' ? ['css', 'legacy'] : ['avoid-all', 'css', 'legacy'] },
      };

      const el = document.createElement('div');
      el.innerHTML = html;
      document.body.appendChild(el);
      html2pdf().set(opt).from(el).save().then(() => {
        document.body.removeChild(el);
      });
    },

    _pdfTable(headers, rows) {
      let h = `<table style="width:100%; border-collapse:collapse; font-size:7px; margin-bottom:3px; page-break-inside:avoid;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        const nowrap = idx === 0 ? 'white-space:nowrap;' : '';
        h += `<th style="border:1px solid #333; background:#C00; color:#fff; padding:1px 2px; text-align:${align}; ${nowrap} font-size:6px;">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f2f2f2';
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const nowrap = idx === 0 ? 'white-space:nowrap;' : '';
          h += `<td style="border:1px solid #999; padding:1px 2px; background:${bg}; font-size:7px; text-align:${align}; ${nowrap}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    _pdfMmTable(headers, rows) {
      let h = `<table style="width:100%; border-collapse:collapse; font-size:5px; margin-bottom:3px; table-layout:fixed;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        const w = idx === 0 ? 'width:90px;' : '';
        h += `<th style="border:1px solid #333; background:#C00; color:#fff; padding:1px 1px; text-align:${align}; font-size:5px; overflow:hidden; ${w}">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f2f2f2';
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const nowrap = idx === 0 ? 'white-space:nowrap; overflow:hidden;' : '';
          h += `<td style="border:1px solid #999; padding:1px 1px; background:${bg}; font-size:5px; text-align:${align}; ${nowrap}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    // ─── 3D Design PDF (Larry_ex format) ─────────
    _larryCell(actual, goal) {
      // Actual cell with red/green background based on goal
      if (goal === 'NA' || goal === null || goal === undefined || goal === '') return 'NA';
      const a = Number(actual) || 0;
      const g = Number(goal);
      if (isNaN(g)) return String(a);
      const bg = a >= g ? '#00B050' : '#FF0000';
      return `<span style="background:${bg}; color:#fff; padding:1px 4px; font-weight:600;">${a}</span>`;
    },

    _larryTable(headers, rows, opts = {}) {
      const headerBg = opts.headerBg || '#D9D2E9';
      let h = `<table style="width:100%; border-collapse:collapse; font-size:10px; margin-bottom:6px;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        h += `<th style="border:1px solid #999; background:${headerBg}; padding:3px 6px; text-align:${align}; font-size:10px; font-weight:600;">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f5f5f5';
        const isTotalRow = opts.totalRowIdx === i;
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const fw = isTotalRow ? 'font-weight:700;' : '';
          h += `<td style="border:1px solid #999; padding:2px 6px; background:${bg}; font-size:10px; text-align:${align}; ${fw}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    async export3dDesignPdf() {
      const isNoon = this.activeTab === 'noon';
      const constants = this.constantsRecords;

      // Build lookup: name -> constant row
      const constMap = {};
      constants.forEach(c => {
        const key = c.Name + '|' + (c.ShiftType || 'Morning');
        constMap[key] = c;
      });

      // Build actual data lookup from noon/3pm rows
      const noonMap = {};
      this.noonRows.forEach(r => { noonMap[r.Name] = r; });
      const pm3Map = {};
      this.pm3Rows.forEach(r => { pm3Map[r.Name] = r; });

      // Get data date
      const dataDate = this.middaySummaryAll(isNoon ? this.noonRows : this.pm3Rows).date;
      const d = new Date(dataDate + 'T00:00:00');
      const dateStr = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(2)}`;

      // Group constants by ShiftType
      const morning = constants.filter(c => c.ShiftType === 'Morning');
      const evening = constants.filter(c => c.ShiftType === 'Evening');
      const outsource = constants.filter(c => c.ShiftType === 'Outsource');

      let html = `<div style="font-family:Arial,sans-serif; padding:12px;">`;
      html += `<p style="margin:0 0 2px; font-size:12px;"><strong>DATE:</strong> &nbsp; ${dateStr}</p>`;
      html += `<p style="margin:0 0 8px; font-size:12px; font-weight:600;">Morning shift</p>`;

      // Morning shift table
      let mHeaders, mRows;
      if (isNoon) {
        mHeaders = ['Designer', 'By 12 PM', '12:00 PM', 'Notes'];
        mRows = morning.map(c => {
          const actual = noonMap[c.Name];
          const noonGoal = c.Noon;
          const noonActual = actual ? actual.Cases : null;
          return [
            c.Name,
            noonGoal === 'NA' ? 'NA' : noonGoal,
            this._larryCell(noonActual, noonGoal),
            '',
          ];
        });
        // Total row
        const totalNoonGoal = morning.reduce((s, c) => c.Noon !== 'NA' ? s + (Number(c.Noon) || 0) : s, 0);
        const totalNoonActual = morning.reduce((s, c) => {
          const a = noonMap[c.Name];
          return a && c.Noon !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        mRows.push([
          '<strong>Total made by this time:</strong>',
          totalNoonGoal,
          this._larryCell(totalNoonActual, totalNoonGoal),
          '',
        ]);
      } else {
        mHeaders = ['Designer', 'By 12 PM', '12:00 PM', 'By 3 PM', '3:00 PM', 'Notes'];
        mRows = morning.map(c => {
          const noonActualRow = noonMap[c.Name];
          const pm3ActualRow = pm3Map[c.Name];
          const noonGoal = c.Noon;
          const pm3Goal = c['3PM'];
          const noonActual = noonActualRow ? noonActualRow.Cases : null;
          const pm3Actual = pm3ActualRow ? pm3ActualRow.Cases : null;
          return [
            c.Name,
            noonGoal === 'NA' ? 'NA' : noonGoal,
            this._larryCell(noonActual, noonGoal),
            pm3Goal === 'NA' ? 'NA' : pm3Goal,
            this._larryCell(pm3Actual, pm3Goal),
            '',
          ];
        });
        // Total row
        const totalNoonGoal = morning.reduce((s, c) => c.Noon !== 'NA' ? s + (Number(c.Noon) || 0) : s, 0);
        const totalNoonActual = morning.reduce((s, c) => {
          const a = noonMap[c.Name];
          return a && c.Noon !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        const totalPm3Goal = morning.reduce((s, c) => c['3PM'] !== 'NA' ? s + (Number(c['3PM']) || 0) : s, 0);
        const totalPm3Actual = morning.reduce((s, c) => {
          const a = pm3Map[c.Name];
          return a && c['3PM'] !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        mRows.push([
          '<strong>Total made by this time:</strong>',
          totalNoonGoal,
          this._larryCell(totalNoonActual, totalNoonGoal),
          totalPm3Goal,
          this._larryCell(totalPm3Actual, totalPm3Goal),
          '',
        ]);
      }
      html += this._larryTable(mHeaders, mRows, { totalRowIdx: mRows.length - 1 });

      // Evening Shift
      if (evening.length) {
        html += `<p style="margin:12px 0 2px; font-size:12px; font-weight:600;">Evening Shift</p>`;
        const eHeaders = ['Designer', 'Capacity', 'Made', 'Notes'];
        const eRows = evening.map(c => {
          const actual = pm3Map[c.Name] || noonMap[c.Name];
          const capacity = c['3PM'] === 'NA' ? 'NA' : c['3PM'];
          const made = actual ? actual.Cases : 0;
          return [c.Name, capacity, this._larryCell(made, capacity), ''];
        });
        html += this._larryTable(eHeaders, eRows, { headerBg: '#D9D2E9' });
      }

      // Outsource
      if (outsource.length) {
        html += `<p style="margin:12px 0 2px; font-size:12px; font-weight:600;">Outsource</p>`;
        const oHeaders = ['Designer', 'Capacity', 'Made', 'Notes'];
        const oRows = outsource.map(c => {
          const actual = pm3Map[c.Name] || noonMap[c.Name];
          const capacity = c['3PM'] === 'NA' ? 'NA' : c['3PM'];
          const made = actual ? actual.Cases : 0;
          return [c.Name, capacity, this._larryCell(made, capacity), ''];
        });
        html += this._larryTable(oHeaders, oRows, { headerBg: '#D9D2E9' });
      }

      // Yesterday totals from Daily EFF data
      const dailyRows = this.dailyRows.filter(r => r.Team !== 'z_Not On Report');
      if (dailyRows.length) {
        // Get latest date
        const dates = [...new Set(dailyRows.map(r => String(r.Date || '')))].sort().reverse();
        const latestDate = dates[0];
        const yesterdayRows = dailyRows.filter(r => String(r.Date || '').startsWith(latestDate));

        // Match by MT Name to constants Name
        const constNames = new Set(constants.map(c => c.Name));
        const matchedRows = yesterdayRows.filter(r => constNames.has(r['MT Name']));

        const totalParts = matchedRows.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);

        // Total MARPEs: only DesignType=Marpe employees
        const marpeNames = new Set(constants.filter(c => c.DesignType === 'Marpe').map(c => c.Name));
        const totalMarpes = yesterdayRows
          .filter(r => marpeNames.has(r['MT Name']))
          .reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);

        html += `<p style="margin:16px 0 2px; font-size:11px;"><strong>Total parts made from yesterday:</strong> &nbsp; ${totalParts}</p>`;
        html += `<p style="margin:2px 0; font-size:11px;"><strong>Total MARPEs made from yesterday:</strong> &nbsp; ${totalMarpes}</p>`;
      }

      html += `</div>`;

      const opt = {
        margin: [8, 8, 8, 8],
        filename: `3D_Design_Report_${dataDate}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      };

      const el = document.createElement('div');
      el.innerHTML = html;
      document.body.appendChild(el);
      html2pdf().set(opt).from(el).save().then(() => {
        document.body.removeChild(el);
      });
    },
  };
}
</script>
{% endblock %}
