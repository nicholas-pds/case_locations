{% extends "base.html" %}
{% block title %}Efficiency{% endblock %}

{% block content %}
<div x-data="efficiencyPage()" x-init="init()">

  <!-- Page Header -->
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
    <h1 class="page-title">Efficiency Report</h1>
    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      {% if latest_date %}
      <span style="font-size:12px; color:#888;">Latest data: {{ latest_date }}</span>
      {% endif %}
      <span x-show="uploadStatus" x-text="uploadStatus"
            :style="uploadError ? 'color:#e74c3c; font-size:13px;' : 'color:#27ae60; font-size:13px;'"></span>
      <label class="export-btn" style="cursor:pointer; display:inline-flex; align-items:center; gap:6px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload Gusto CSV
        <input type="file" accept=".csv" style="display:none;" @change="uploadGusto($event)">
      </label>
      <button class="export-btn" @click="refreshMidday()" x-show="activeTab === 'noon' || activeTab === '3pm'">Refresh Midday</button>
      <button class="export-btn" @click="exportPdf()">Export PDF</button>
      <a class="export-btn" href="/efficiency/export/mm" x-show="activeTab === 'mm'" style="text-decoration:none;">Download CSV</a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="customer-tabs">
    <button class="customer-tab" :class="{ active: activeTab === 'daily' }" @click="activeTab = 'daily'">Daily EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === 'mm' }" @click="activeTab = 'mm'">MM EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === 'noon' }" @click="activeTab = 'noon'">Noon EFF</button>
    <button class="customer-tab" :class="{ active: activeTab === '3pm' }" @click="activeTab = '3pm'">3PM EFF</button>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- DAILY EFF TAB                               -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'daily'">
    <!-- Filters -->
    <div class="customer-filters">
      <select class="filter-select" x-model="dailyDate">
        <option value="">All Dates</option>
        {% for d in available_dates %}
        <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
      <input type="text" class="search-input" placeholder="Search name, team..." x-model="dailySearch" style="flex:1; max-width:280px;">
      <select class="filter-select" x-model="dailyTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="clear-filters-btn" @click="clearDailyFilters()"
              x-show="dailySearch || dailyTeam || dailyDate !== {{ latest_date | tojson }}">Clear</button>
    </div>

    <!-- ALL Summary -->
    <template x-if="filteredDailyRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="dailySummaryAll().date"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().people"></td>
              <td style="text-align:center; font-weight:600;" :style="effColor(dailySummaryAll().eff)" x-text="dailySummaryAll().eff.toFixed(0) + '%'"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().cases"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().tasks"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().duration.toFixed(1)"></td>
              <td style="text-align:right;" x-text="dailySummaryAll().hours.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="filteredDailyRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in dailySummaryTeams()" :key="'ts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:center; font-weight:600;" :style="effColor(ts.eff)" x-text="ts.eff > 0 ? ts.eff.toFixed(0) + '%' : ''"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
                <td style="text-align:right;" x-text="ts.hours.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Detail Sections -->
    <template x-for="section in dailyTeamSections()" :key="'sec-'+section.team">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label" x-text="section.team"></div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th>Name</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in section.rows" :key="'d-'+row.EmployeeID">
              <tr>
                <td x-text="row.Team || ''"></td>
                <td x-text="row['MT Name'] || ''" style="white-space:nowrap;"></td>
                <td style="text-align:center; font-weight:600;" :style="effColor(row.Efficiency)" x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                <td style="text-align:right;" x-text="row.Cases_Worked_On || 0"></td>
                <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                <td style="text-align:right;" x-text="(row.Tasks_Duration_Hours || 0).toFixed(1)"></td>
                <td style="text-align:right;" x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Training Section -->
    <template x-if="dailyTrainingRows().length > 0">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label">Training</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th>Name</th>
              <th style="text-align:center;">EFF</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
              <th style="text-align:right;">Work Hours</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in dailyTrainingRows()" :key="'tr-'+row.EmployeeID">
              <tr>
                <td x-text="row.Team || ''"></td>
                <td x-text="row['MT Name'] || ''" style="white-space:nowrap;"></td>
                <td style="text-align:center; font-weight:600;" :style="effColor(row.Efficiency)" x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                <td style="text-align:right;" x-text="row.Cases_Worked_On || 0"></td>
                <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                <td style="text-align:right;" x-text="(row.Tasks_Duration_Hours || 0).toFixed(1)"></td>
                <td style="text-align:right;" x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <div x-show="filteredDailyRows().length === 0" style="text-align:center; padding:24px; color:#888;">
      No data — upload a Gusto CSV to get started
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- MM EFF TAB                                  -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'mm'">
    <div class="customer-filters">
      <select class="filter-select" x-model="mmTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="clear-filters-btn" @click="mmTeam=''" x-show="mmTeam">Clear</button>
    </div>

    <!-- Teams Summary Grid -->
    <template x-if="filteredMMRows().length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label" x-text="dailyDate ? dailyDate : 'Multi-Period'"></div>
        <div class="customer-table-wrap">
          <table class="eff-table">
            <thead>
              <tr>
                <th style="position:sticky; left:0; z-index:2; background:#2C2C2C;">Teams</th>
                {% for col in mm_eff_cols %}
                <th style="white-space:nowrap; text-align:right; font-size:11px;">{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="ts in mmTeamsSummary()" :key="'mmts-'+ts.team">
                <tr>
                  <td style="font-weight:600; white-space:nowrap; position:sticky; left:0; z-index:1; background:inherit;" x-text="ts.team"></td>
                  {% for col in mm_eff_cols %}
                  <td style="text-align:right; font-size:12px; font-weight:600;"
                      :style="mmEffColor(ts['{{ col }}'])"
                      x-text="formatMmEff(ts['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <!-- Per-Team Detail Sections -->
    <template x-for="section in mmTeamSections()" :key="'mmsec-'+section.team">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label" x-text="section.team"></div>
        <div class="customer-table-wrap">
          <table class="eff-table">
            <thead>
              <tr>
                <th style="position:sticky; left:0; z-index:2; background:#2C2C2C;">Team</th>
                <th style="position:sticky; left:0; z-index:2; background:#2C2C2C;">Name</th>
                {% for col in mm_eff_cols %}
                <th style="white-space:nowrap; text-align:right; font-size:11px;">{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'mm-'+row['MT Name']">
                <tr>
                  <td x-text="row.Team || ''" style="white-space:nowrap;"></td>
                  <td x-text="row['MT Name'] || ''" style="white-space:nowrap;"></td>
                  {% for col in mm_eff_cols %}
                  <td style="text-align:right; font-size:12px; font-weight:600;"
                      :style="mmEffColor(row['{{ col }}'])"
                      x-text="formatMmEff(row['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <div x-show="filteredMMRows().length === 0" style="text-align:center; padding:24px; color:#888;">
      No aggregated data — upload a Gusto CSV to get started
    </div>
  </div>


  <!-- ═══════════════════════════════════════════ -->
  <!-- NOON EFF TAB                                -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === 'noon'">
    <div style="padding:8px 0 12px; color:#888; font-size:13px;">
      Snapshot: today 3:00 AM – 12:00 PM · Updated automatically at noon on business days
    </div>

    <!-- ALL Summary -->
    <template x-if="noonRows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="middaySummaryAll(noonRows).date"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).people"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).cases"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).tasks"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(noonRows).duration.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="noonRows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Team/Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in middaySummaryTeams(noonRows)" :key="'nts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Details -->
    <template x-for="section in middayTeamSections(noonRows)" :key="'nsec-'+section.team">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label" x-text="section.team"></div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th>Name</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in section.rows" :key="'n-'+row.Name">
              <tr>
                <td x-text="row.Team || ''"></td>
                <td x-text="row.Name || ''" style="white-space:nowrap;"></td>
                <td style="text-align:right;" x-text="row.Cases || 0"></td>
                <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                <td style="text-align:right;" x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <div x-show="noonRows.length === 0" style="text-align:center; padding:24px; color:#888;">
      No noon data yet — updates automatically at 12:00 PM on business days
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- 3PM EFF TAB                                 -->
  <!-- ═══════════════════════════════════════════ -->
  <div x-show="activeTab === '3pm'">
    <div style="padding:8px 0 12px; color:#888; font-size:13px;">
      Snapshot: today 3:00 AM – 3:00 PM · Updated automatically at 3:00 PM on business days
    </div>

    <!-- ALL Summary -->
    <template x-if="pm3Rows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">ALL</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="middaySummaryAll(pm3Rows).date"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).people"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).cases"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).tasks"></td>
              <td style="text-align:right;" x-text="middaySummaryAll(pm3Rows).duration.toFixed(1)"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Teams Summary -->
    <template x-if="pm3Rows.length > 0">
      <div style="margin-bottom:20px;">
        <div class="eff-section-label">Teams</div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Team/Group</th>
              <th style="text-align:right;">Num of People</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ts in middaySummaryTeams(pm3Rows)" :key="'pts-'+ts.team">
              <tr>
                <td style="font-weight:600;" x-text="ts.team"></td>
                <td style="text-align:right;" x-text="ts.people"></td>
                <td style="text-align:right;" x-text="ts.cases"></td>
                <td style="text-align:right;" x-text="ts.tasks"></td>
                <td style="text-align:right;" x-text="ts.duration.toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Per-Team Details -->
    <template x-for="section in middayTeamSections(pm3Rows)" :key="'psec-'+section.team">
      <div style="margin-bottom:24px;">
        <div class="eff-section-label" x-text="section.team"></div>
        <table class="eff-table">
          <thead>
            <tr>
              <th>Group</th>
              <th>Name</th>
              <th style="text-align:right;">Cases Worked On</th>
              <th style="text-align:right;">Tasks Completed</th>
              <th style="text-align:right;">Tasks Duration</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in section.rows" :key="'p-'+row.Name">
              <tr>
                <td x-text="row.Team || ''"></td>
                <td x-text="row.Name || ''" style="white-space:nowrap;"></td>
                <td style="text-align:right;" x-text="row.Cases || 0"></td>
                <td style="text-align:right;" x-text="row.Tasks_Completed || 0"></td>
                <td style="text-align:right;" x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <div x-show="pm3Rows.length === 0" style="text-align:center; padding:24px; color:#888;">
      No 3PM data yet — updates automatically at 3:00 PM on business days
    </div>
  </div>

</div><!-- end x-data -->

<style>
  .eff-section-label {
    font-size: 14px;
    font-weight: 700;
    color: #C0392B;
    padding: 8px 0 4px;
    letter-spacing: 0.03em;
  }
  .eff-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 4px;
  }
  .eff-table thead th {
    background: #2C2C2C;
    color: #FFFFFF;
    padding: 6px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    white-space: nowrap;
    border-bottom: 1px solid #E0E0E0;
  }
  .eff-table tbody td {
    padding: 4px 10px;
    border-bottom: 1px solid #E0E0E0;
    font-size: 13px;
    color: #1A1A1A;
  }
  .eff-table tbody tr {
    background: #FFFFFF;
  }
  .eff-table tbody tr:nth-child(even) {
    background: #FAFAFA;
  }
  .eff-table tbody tr:hover {
    background: #F0F0F0;
  }
</style>

<script>
function efficiencyPage() {
  return {
    activeTab: 'daily',

    // Daily EFF state
    dailyRows: {{ daily_records | tojson }},
    dailyDate: {{ latest_date | tojson }},
    dailySearch: '',
    dailyTeam: '',

    // MM EFF state
    mmRows: {{ agg_records | tojson }},
    mmTeam: '',

    // Midday state
    noonRows: {{ noon_records | tojson }},
    pm3Rows: {{ pm3_records | tojson }},

    // Upload state
    uploadStatus: '',
    uploadError: false,

    // Efficiency column names for MM
    mmEffCols: {{ mm_eff_cols | tojson }},

    init() {},

    // ─── Daily EFF ───────────────────────────────
    filteredDailyRows() {
      let rows = this.dailyRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.dailyDate) rows = rows.filter(r => String(r.Date || '').startsWith(this.dailyDate));
      if (this.dailyTeam) rows = rows.filter(r => r.Team === this.dailyTeam);
      if (this.dailySearch.trim()) {
        const q = this.dailySearch.trim().toLowerCase();
        rows = rows.filter(r =>
          String(r['MT Name'] || '').toLowerCase().includes(q) ||
          String(r.Team || '').toLowerCase().includes(q)
        );
      }
      return rows;
    },

    dailySummaryAll() {
      const rows = this.filteredDailyRows();
      if (!rows.length) return { date: '', people: 0, eff: 0, cases: 0, tasks: 0, duration: 0, hours: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
      const hours = rows.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
      const eff = hours > 0 ? (duration / hours) * 100 : 0;
      const date = this.dailyDate || (rows[0] ? rows[0].Date : '');
      return { date, people, eff, cases, tasks, duration, hours };
    },

    dailySummaryTeams() {
      const rows = this.filteredDailyRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const cases = tr.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
        const tasks = tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
        const duration = tr.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
        const hours = tr.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
        const eff = hours > 0 ? (duration / hours) * 100 : 0;
        return { team, people: tr.length, eff, cases, tasks, duration, hours };
      });
    },

    dailyTeamSections() {
      const rows = this.filteredDailyRows().filter(r => r['Training Plan'] != 1);
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0))
      }));
    },

    dailyTrainingRows() {
      return this.filteredDailyRows()
        .filter(r => r['Training Plan'] == 1)
        .sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0));
    },

    clearDailyFilters() {
      this.dailyDate = {{ latest_date | tojson }};
      this.dailySearch = '';
      this.dailyTeam = '';
    },

    effColor(val) {
      const n = Number(val) || 0;
      if (n >= 80) return 'color: #27AE60;';
      if (n >= 50) return '';
      if (n > 0) return 'color: #C0392B;';
      return 'color: #999;';
    },

    // ─── MM EFF ──────────────────────────────────
    filteredMMRows() {
      let rows = this.mmRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.mmTeam) rows = rows.filter(r => r.Team === this.mmTeam);
      return rows;
    },

    mmTeamsSummary() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      const effCols = this.mmEffCols;
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const summary = { team };
        effCols.forEach(col => {
          // Average non-"x" values
          const vals = tr.map(r => r[col]).filter(v => v !== 'x' && v !== null && v !== undefined && !isNaN(Number(v)));
          summary[col] = vals.length > 0 ? vals.reduce((s, v) => s + Number(v), 0) / vals.length : 'x';
        });
        return summary;
      });
    },

    mmTeamSections() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a['MT Name'] || '').localeCompare(String(b['MT Name'] || '')))
      }));
    },

    mmEffColor(val) {
      if (val === 'x' || val === null || val === undefined) return 'color:#999;';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'color:#999;';
      if (n >= 0.80) return 'color:#27AE60;';
      if (n >= 0.50) return '';
      return 'color:#C0392B;';
    },

    formatMmEff(val) {
      if (val === 'x') return '';
      if (val === null || val === undefined || val === 0) return '';
      const n = Number(val);
      if (isNaN(n)) return '';
      return (n * 100).toFixed(0) + '%';
    },

    // ─── Midday ──────────────────────────────────
    middaySummaryAll(rows) {
      if (!rows.length) return { date: '', people: 0, cases: 0, tasks: 0, duration: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0);
      const today = new Date().toISOString().slice(0, 10);
      return { date: today, people, cases, tasks, duration };
    },

    middaySummaryTeams(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        return {
          team,
          people: tr.length,
          cases: tr.reduce((s, r) => s + (Number(r.Cases) || 0), 0),
          tasks: tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0),
          duration: tr.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0),
        };
      });
    },

    middayTeamSections(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a.Name || '').localeCompare(String(b.Name || '')))
      }));
    },

    // ─── Upload ──────────────────────────────────
    async uploadGusto(event) {
      const file = event.target.files[0];
      if (!file) return;
      this.uploadStatus = 'Uploading...';
      this.uploadError = false;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const resp = await fetch('/efficiency/upload', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Uploaded ${data.date_range} — ${data.new_rows} employees processed`;
          this.uploadError = false;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Upload failed — check console';
        this.uploadError = true;
      }
      event.target.value = '';
    },

    // ─── Refresh Midday ──────────────────────────
    async refreshMidday() {
      this.uploadStatus = 'Refreshing midday data...';
      this.uploadError = false;
      try {
        const resp = await fetch('/efficiency/refresh-midday', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Midday refreshed — noon: ${data.rows.noon} rows, 3pm: ${data.rows['3pm']} rows`;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Refresh failed — check console';
        this.uploadError = true;
      }
    },

    // ─── PDF Export ──────────────────────────────
    exportPdf() {
      const tabNames = { daily: 'Daily_EFF', mm: 'MM_EFF', noon: 'Noon_EFF', '3pm': '3PM_EFF' };
      const tabLabel = tabNames[this.activeTab] || 'Efficiency';
      const today = new Date().toISOString().slice(0, 10);
      const filename = `Efficiency_${tabLabel}_${today}.pdf`;

      let html = `<div style="font-family:Arial,sans-serif; padding:20px;">`;

      if (this.activeTab === 'daily') {
        const summary = this.dailySummaryAll();
        html += `<h2 style="margin:0 0 12px; color:#222;">${summary.date}</h2>`;

        // ALL table
        html += `<p style="margin:0 0 4px; font-weight:700; font-size:12px;">ALL</p>`;
        html += this._pdfTable(
          ['Date','Num of People','EFF','Cases Worked On','Tasks Completed','Tasks Duration','Work Hours'],
          [[summary.date, summary.people, summary.eff.toFixed(0)+'%', summary.cases, summary.tasks, summary.duration.toFixed(1), summary.hours.toFixed(1)]]
        );

        // Teams table
        html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">Teams</p>`;
        const teamRows = this.dailySummaryTeams().map(ts => [
          ts.team, ts.people, ts.eff > 0 ? ts.eff.toFixed(0)+'%' : '', ts.cases, ts.tasks, ts.duration.toFixed(1), ts.hours.toFixed(1)
        ]);
        html += this._pdfTable(['Group','Num of People','EFF','Cases Worked On','Tasks Completed','Tasks Duration','Work Hours'], teamRows);

        // Per-team
        this.dailyTeamSections().forEach(sec => {
          html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [
            r.Team || '', r['MT Name'] || '', r.Efficiency > 0 ? r.Efficiency.toFixed(0)+'%' : '',
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Group','Name','EFF','Cases Worked On','Tasks Completed','Tasks Duration','Work Hours'], rows);
        });

        // Training
        const trainRows = this.dailyTrainingRows();
        if (trainRows.length) {
          html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">Training</p>`;
          const rows = trainRows.map(r => [
            r.Team || '', r['MT Name'] || '', r.Efficiency > 0 ? r.Efficiency.toFixed(0)+'%' : '',
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Group','Name','EFF','Cases Worked On','Tasks Completed','Tasks Duration','Work Hours'], rows);
        }

      } else if (this.activeTab === 'mm') {
        const effCols = this.mmEffCols;
        const headers = ['Teams', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];
        html += `<h2 style="margin:0 0 12px; color:#222;">Multi-Period Efficiency</h2>`;

        // Teams summary
        const teamRows = this.mmTeamsSummary().map(ts => [ts.team, ...effCols.map(c => this.formatMmEff(ts[c]))]);
        html += this._pdfTable(headers, teamRows);

        // Per-team
        const detailHeaders = ['Team', 'Name', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];
        this.mmTeamSections().forEach(sec => {
          html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [r.Team || '', r['MT Name'] || '', ...effCols.map(c => this.formatMmEff(r[c]))]);
          html += this._pdfTable(detailHeaders, rows);
        });

      } else {
        const isNoon = this.activeTab === 'noon';
        const src = isNoon ? this.noonRows : this.pm3Rows;
        const label = isNoon ? '12:00 PM' : '3:00 PM';
        html += `<h2 style="margin:0 0 12px; color:#222;">${label} Snapshot</h2>`;

        const summary = this.middaySummaryAll(src);
        html += `<p style="margin:0 0 4px; font-weight:700; font-size:12px;">ALL</p>`;
        html += this._pdfTable(
          ['Date','Num of People','Cases Worked On','Tasks Completed','Tasks Duration'],
          [[summary.date, summary.people, summary.cases, summary.tasks, summary.duration.toFixed(1)]]
        );

        html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">Teams</p>`;
        const teamRows = this.middaySummaryTeams(src).map(ts => [ts.team, ts.people, ts.cases, ts.tasks, ts.duration.toFixed(1)]);
        html += this._pdfTable(['Team/Group','Num of People','Cases Worked On','Tasks Completed','Tasks Duration'], teamRows);

        this.middayTeamSections(src).forEach(sec => {
          html += `<p style="margin:16px 0 4px; font-weight:700; font-size:12px;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [r.Team || '', r.Name || '', r.Cases || 0, r.Tasks_Completed || 0, (r.Total_Duration_Hours || 0).toFixed(1)]);
          html += this._pdfTable(['Group','Name','Cases Worked On','Tasks Completed','Tasks Duration'], rows);
        });
      }

      html += `</div>`;

      const opt = {
        margin: [10, 10, 10, 10],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'landscape' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      };

      const el = document.createElement('div');
      el.innerHTML = html;
      document.body.appendChild(el);
      html2pdf().set(opt).from(el).save().then(() => {
        document.body.removeChild(el);
      });
    },

    _pdfTable(headers, rows) {
      let h = `<table style="width:100%; border-collapse:collapse; font-size:10px; margin-bottom:4px;">`;
      h += `<thead><tr>`;
      headers.forEach(hdr => {
        h += `<th style="border:1px solid #ccc; background:#2c3e50; color:#fff; padding:4px 6px; text-align:left; white-space:nowrap; font-size:9px;">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f7f8fa';
        h += `<tr>`;
        cells.forEach(c => {
          h += `<td style="border:1px solid #ddd; padding:3px 6px; background:${bg}; font-size:9px;">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },
  };
}
</script>
{% endblock %}
