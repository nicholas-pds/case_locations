{% extends "base.html" %}
{% block title %}Efficiency{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/efficiency.css?v=4">
{% endblock %}

{% block content %}
<div class="eff-page-wrapper" x-data="efficiencyPage()" x-init="init()">

  <!-- Page Header -->
  <div class="eff-header">
    <div class="eff-logo-area">
      <img src="/static/logo.png" alt="Partners Dental Solutions" class="eff-logo">
      <div>
        <h1 class="eff-title">Efficiency Report</h1>
        <div class="eff-subtitle" x-text="getSubtitleDate()"></div>
      </div>
    </div>
    <div class="eff-header-actions">
      <span x-show="uploadStatus" x-text="uploadStatus"
            :class="uploadError ? 'eff-error' : 'eff-success'"></span>
      <label class="eff-btn eff-btn-upload" x-show="activeTab === 'daily'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload Gusto CSV
        <input type="file" accept=".csv" style="display:none;" @change="uploadGusto($event)">
      </label>
      <button class="eff-btn eff-btn-primary" @click="exportPdf()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17"/></svg>
        Export PDF
      </button>
      <button class="eff-btn eff-btn-primary" @click="export3dDesignPdf()" x-show="activeTab === 'noon' || activeTab === '3pm'">Export 3D Design PDF</button>
      <button class="eff-btn eff-btn-secondary" @click="openConstantsModal()" x-show="activeTab === 'noon' || activeTab === '3pm'">Edit Constants</button>
      <button class="eff-btn eff-btn-secondary" @click="openEmployeesModal()" x-show="activeTab === 'daily'">Edit Employees</button>
      <button class="eff-btn eff-btn-secondary" @click="refreshMidday()" x-show="activeTab === 'noon' || activeTab === '3pm'">Refresh Data</button>
      <a class="eff-btn eff-btn-secondary" href="/efficiency/export/mm" x-show="activeTab === 'mm'">Download CSV</a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="eff-tabs">
    <button class="eff-tab" :class="{ active: activeTab === 'daily' }" @click="activeTab = 'daily'">Daily EFF</button>
    <button class="eff-tab" :class="{ active: activeTab === 'mm' }" @click="activeTab = 'mm'">MM EFF</button>
    <button class="eff-tab" :class="{ active: activeTab === 'noon' }" @click="activeTab = 'noon'">Noon EFF</button>
    <button class="eff-tab" :class="{ active: activeTab === '3pm' }" @click="activeTab = '3pm'">3PM EFF</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- DAILY EFF TAB                               -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="activeTab === 'daily'">
    <!-- Filters -->
    <div class="eff-filter-bar">
      <select class="eff-filter-select" x-model="dailyDate">
        <option value="">All Dates</option>
        {% for d in available_dates %}
        <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
      <input type="text" class="eff-filter-input" placeholder="Search name, team..." x-model="dailySearch">
      <select class="eff-filter-select" x-model="dailyTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="eff-clear-btn" @click="clearDailyFilters()"
              x-show="dailySearch || dailyTeam || dailyDate !== {{ latest_date | tojson }}">Clear</button>
    </div>

    <!-- KPI Cards -->
    <template x-if="filteredDailyRows().length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Overview</div>
        <div class="eff-kpi-row">
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Overall EFF</div>
            <div class="eff-kpi-value" :class="'eff-' + effTierClass(dailySummaryAll().eff)" x-text="dailySummaryAll().eff.toFixed(0) + '%'"></div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">People</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="dailySummaryAll().people"></div>
            <div class="eff-kpi-sub" x-text="'across ' + dailySummaryTeams().length + ' teams'"></div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Cases</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="dailySummaryAll().cases.toLocaleString()"></div>
            <div class="eff-kpi-sub">total processed</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Tasks</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="dailySummaryAll().tasks.toLocaleString()"></div>
            <div class="eff-kpi-sub">total completed</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Work Hours</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="dailySummaryAll().hours.toFixed(1)"></div>
            <div class="eff-kpi-sub" x-text="dailySummaryAll().duration.toFixed(1) + ' hrs duration'"></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Team Performance Bar Chart -->
    <template x-if="filteredDailyRows().length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Team Performance</div>
        <div class="eff-teams-chart">
          <div class="eff-bar-header">
            <div class="eff-col-label left">Team</div>
            <div class="eff-col-label">Efficiency</div>
            <div class="eff-col-label">EFF%</div>
            <div class="eff-col-label">Cases</div>
            <div class="eff-col-label">Tasks</div>
            <div class="eff-col-label">Work Hrs</div>
          </div>
          <template x-for="ts in dailySummaryTeamsSorted()" :key="'bar-'+ts.team">
            <div class="eff-bar-row">
              <div class="eff-team-name" x-text="ts.team"></div>
              <div class="eff-bar-track">
                <div class="eff-bar-fill" :class="'bar-' + effTierClass(ts.eff)"
                     :style="'width:' + Math.min((ts.eff / 150) * 100, 100) + '%'"></div>
              </div>
              <div class="eff-team-eff" :class="'eff-' + effTierClass(ts.eff)" x-text="ts.eff.toFixed(0) + '%'"></div>
              <div class="eff-team-stat" x-text="ts.cases.toLocaleString()"></div>
              <div class="eff-team-stat" x-text="ts.tasks.toLocaleString()"></div>
              <div class="eff-team-stat" x-text="ts.hours.toFixed(1)"></div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Individual Team Breakdowns (3-column card grid) -->
    <template x-if="filteredDailyRows().length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Individual Breakdowns</div>
        <div class="eff-teams-grid">
          <template x-for="section in dailyTeamSections()" :key="'card-'+section.team">
            <div class="eff-team-card">
              <div class="eff-card-header">
                <div class="eff-card-name" x-text="section.team"></div>
                <div class="eff-card-eff" :class="'eff-' + effTierClass(teamAvgEff(section.rows))">
                  <span x-text="teamAvgEff(section.rows).toFixed(0) + '%'"></span>
                  <span style="color:var(--eff-muted);font-size:11px;"> Â· </span>
                  <span style="color:var(--eff-muted);font-size:11px;" x-text="section.rows.length + ' ppl'"></span>
                </div>
              </div>
              <table class="eff-person-table">
                <thead>
                  <tr><th>Name</th><th>EFF</th><th>Cases</th><th>Tasks</th><th>Hrs</th></tr>
                </thead>
                <tbody>
                  <template x-for="row in section.rows" :key="'p-'+row.EmployeeID">
                    <tr>
                      <td x-text="shortName(row['MT Name'])"></td>
                      <td class="eff-cell" :class="'eff-' + effTierClass(row.Efficiency)"
                          x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                      <td x-text="row.Cases_Worked_On || 0"></td>
                      <td x-text="row.Tasks_Completed || 0"></td>
                      <td x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Training Section -->
    <template x-if="dailyTrainingRows().length > 0">
      <div class="eff-section">
        <div class="eff-section-title">
          Training
          <span class="eff-training-note">(excluded from team EFF calculations)</span>
        </div>
        <div class="eff-training-card">
          <div class="eff-training-header">
            <div class="eff-training-title">Training</div>
          </div>
          <table class="eff-person-table">
            <thead>
              <tr><th>Name</th><th>EFF</th><th>Cases</th><th>Tasks</th><th>Work Hrs</th></tr>
            </thead>
            <tbody>
              <template x-for="row in dailyTrainingRows()" :key="'tr-'+row.EmployeeID">
                <tr>
                  <td>
                    <span x-text="shortName(row['MT Name'])"></span>
                    <span class="eff-training-badge">Training</span>
                  </td>
                  <td class="eff-cell" :class="'eff-' + effTierClass(row.Efficiency)"
                      x-text="row.Efficiency > 0 ? row.Efficiency.toFixed(0) + '%' : ''"></td>
                  <td x-text="row.Cases_Worked_On || 0"></td>
                  <td x-text="row.Tasks_Completed || 0"></td>
                  <td x-text="(row['Work Hours'] || 0).toFixed(1)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <!-- Empty State -->
    <div x-show="filteredDailyRows().length === 0" class="eff-empty">
      <div class="eff-empty-icon">ðŸ“Š</div>
      <div class="eff-empty-text">No data â€” upload a Gusto CSV to get started</div>
    </div>

    <!-- Footer -->
    <template x-if="filteredDailyRows().length > 0">
      <div class="eff-footer">
        <div>Partners Dental Solutions â€” Internal Use Only</div>
        <div class="eff-legend">
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green)"></span>
            â‰¥120%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green-light)"></span>
            80â€“119%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-yellow)"></span>
            65â€“79%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-orange)"></span>
            50â€“64%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-red)"></span>
            &lt;50%
          </span>
        </div>
        <div x-text="'Generated ' + new Date().toISOString().slice(0,10)"></div>
      </div>
    </template>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- MM EFF TAB                                  -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="activeTab === 'mm'">
    <div class="eff-filter-bar">
      <select class="eff-filter-select" x-model="mmTeam">
        <option value="">All Teams</option>
        {% for team in teams %}
        <option value="{{ team }}">{{ team }}</option>
        {% endfor %}
      </select>
      <button class="eff-clear-btn" @click="mmTeam=''" x-show="mmTeam">Clear</button>
    </div>

    <!-- Teams Summary Grid -->
    <template x-if="filteredMMRows().length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Multi-Period Efficiency</div>
        <div class="eff-mm-wrap">
          <table class="eff-mm-table">
            <thead>
              <tr>
                <th>Teams</th>
                {% for col in mm_eff_cols %}
                <th>{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="ts in mmTeamsSummary()" :key="'mmts-'+ts.team">
                <tr>
                  <td x-text="ts.team"></td>
                  {% for col in mm_eff_cols %}
                  <td :class="'eff-' + mmEffTierClass(ts['{{ col }}'])"
                      x-text="formatMmEff(ts['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <!-- Per-Team Detail Sections -->
    <template x-for="section in mmTeamSections()" :key="'mmsec-'+section.team">
      <div class="eff-section">
        <div class="eff-section-title" x-text="section.team"></div>
        <div class="eff-mm-wrap">
          <table class="eff-mm-table">
            <thead>
              <tr>
                <th>Name</th>
                {% for col in mm_eff_cols %}
                <th>{{ col | replace('Efficiency_','') | replace('_',' ') }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <template x-for="row in section.rows" :key="'mm-'+row['MT Name']">
                <tr>
                  <td x-text="shortName(row['MT Name'])"></td>
                  {% for col in mm_eff_cols %}
                  <td :class="'eff-' + mmEffTierClass(row['{{ col }}'])"
                      x-text="formatMmEff(row['{{ col }}'])"></td>
                  {% endfor %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </template>

    <!-- Empty State -->
    <div x-show="filteredMMRows().length === 0" class="eff-empty">
      <div class="eff-empty-icon">ðŸ“Š</div>
      <div class="eff-empty-text">No aggregated data â€” upload a Gusto CSV to get started</div>
    </div>

    <!-- Footer -->
    <template x-if="filteredMMRows().length > 0">
      <div class="eff-footer">
        <div>Partners Dental Solutions â€” Internal Use Only</div>
        <div class="eff-legend">
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green)"></span>
            â‰¥120%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green-light)"></span>
            80â€“119%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-yellow)"></span>
            65â€“79%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-orange)"></span>
            50â€“64%
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-red)"></span>
            &lt;50%
          </span>
        </div>
        <div x-text="'Generated ' + new Date().toISOString().slice(0,10)"></div>
      </div>
    </template>
  </div>


  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- NOON EFF TAB                                -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="activeTab === 'noon'">
    <div style="padding:8px 0 16px; color:var(--eff-muted); font-size:13px;">
      Snapshot: today 3:00 AM â€“ 12:00 PM Â· Updated automatically at noon on business days
    </div>

    <!-- KPI Cards -->
    <template x-if="noonRows.length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Overview</div>
        <div class="eff-kpi-row eff-kpi-row-4">
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">People</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(noonRows).people"></div>
            <div class="eff-kpi-sub" x-text="'across ' + middaySummaryTeams(noonRows).length + ' teams'"></div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Cases</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(noonRows).cases.toLocaleString()"></div>
            <div class="eff-kpi-sub">total worked on</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Tasks</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(noonRows).tasks.toLocaleString()"></div>
            <div class="eff-kpi-sub">total completed</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Duration</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(noonRows).duration.toFixed(1)"></div>
            <div class="eff-kpi-sub">hours</div>
          </div>
        </div>
      </div>
    </template>

    <!-- Team Cards -->
    <template x-if="noonRows.length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Team Breakdowns</div>
        <div class="eff-teams-grid">
          <template x-for="section in middayTeamSections(noonRows)" :key="'ncard-'+section.team">
            <div class="eff-team-card">
              <div class="eff-card-header">
                <div class="eff-card-name" x-text="section.team"></div>
                <div class="eff-card-eff" style="color:var(--eff-muted)">
                  <span x-text="section.rows.length + ' people'"></span>
                </div>
              </div>
              <table class="eff-person-table">
                <thead>
                  <tr><th>Name</th><th>Cases</th><th>Goal</th><th>Tasks</th><th>Hrs</th></tr>
                </thead>
                <tbody>
                  <template x-for="row in section.rows" :key="'np-'+row.Name">
                    <tr>
                      <td x-text="shortName(row.Name)"></td>
                      <td :class="caseGoalClass(row.Cases, row.Noon_Goal)" x-text="row.Cases || 0"></td>
                      <td x-text="row.Noon_Goal || ''"></td>
                      <td x-text="row.Tasks_Completed || 0"></td>
                      <td x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Empty State -->
    <div x-show="noonRows.length === 0" class="eff-empty">
      <div class="eff-empty-icon">ðŸ•›</div>
      <div class="eff-empty-text">No noon data yet â€” updates automatically at 12:00 PM on business days</div>
    </div>

    <!-- Footer -->
    <template x-if="noonRows.length > 0">
      <div class="eff-footer">
        <div>Partners Dental Solutions â€” Internal Use Only</div>
        <div class="eff-legend">
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green)"></span>
            Met Goal
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-red)"></span>
            Below Goal
          </span>
        </div>
        <div x-text="'Generated ' + new Date().toISOString().slice(0,10)"></div>
      </div>
    </template>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- 3PM EFF TAB                                 -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="activeTab === '3pm'">
    <div style="padding:8px 0 16px; color:var(--eff-muted); font-size:13px;">
      Snapshot: today 3:00 AM â€“ 3:00 PM Â· Updated automatically at 3:00 PM on business days
    </div>

    <!-- KPI Cards -->
    <template x-if="pm3Rows.length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Overview</div>
        <div class="eff-kpi-row eff-kpi-row-4">
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">People</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(pm3Rows).people"></div>
            <div class="eff-kpi-sub" x-text="'across ' + middaySummaryTeams(pm3Rows).length + ' teams'"></div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Cases</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(pm3Rows).cases.toLocaleString()"></div>
            <div class="eff-kpi-sub">total worked on</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Tasks</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(pm3Rows).tasks.toLocaleString()"></div>
            <div class="eff-kpi-sub">total completed</div>
          </div>
          <div class="eff-kpi-card">
            <div class="eff-kpi-label">Duration</div>
            <div class="eff-kpi-value" style="color:var(--eff-accent)" x-text="middaySummaryAll(pm3Rows).duration.toFixed(1)"></div>
            <div class="eff-kpi-sub">hours</div>
          </div>
        </div>
      </div>
    </template>

    <!-- Team Cards -->
    <template x-if="pm3Rows.length > 0">
      <div class="eff-section">
        <div class="eff-section-title">Team Breakdowns</div>
        <div class="eff-teams-grid">
          <template x-for="section in middayTeamSections(pm3Rows)" :key="'pcard-'+section.team">
            <div class="eff-team-card">
              <div class="eff-card-header">
                <div class="eff-card-name" x-text="section.team"></div>
                <div class="eff-card-eff" style="color:var(--eff-muted)">
                  <span x-text="section.rows.length + ' people'"></span>
                </div>
              </div>
              <table class="eff-person-table">
                <thead>
                  <tr><th>Name</th><th>Cases</th><th>Goal</th><th>Tasks</th><th>Hrs</th></tr>
                </thead>
                <tbody>
                  <template x-for="row in section.rows" :key="'pp-'+row.Name">
                    <tr>
                      <td x-text="shortName(row.Name)"></td>
                      <td :class="caseGoalClass(row.Cases, row.PM3_Goal)" x-text="row.Cases || 0"></td>
                      <td x-text="row.PM3_Goal || ''"></td>
                      <td x-text="row.Tasks_Completed || 0"></td>
                      <td x-text="(row.Total_Duration_Hours || 0).toFixed(1)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Empty State -->
    <div x-show="pm3Rows.length === 0" class="eff-empty">
      <div class="eff-empty-icon">ðŸ•’</div>
      <div class="eff-empty-text">No 3PM data yet â€” updates automatically at 3:00 PM on business days</div>
    </div>

    <!-- Footer -->
    <template x-if="pm3Rows.length > 0">
      <div class="eff-footer">
        <div>Partners Dental Solutions â€” Internal Use Only</div>
        <div class="eff-legend">
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-green)"></span>
            Met Goal
          </span>
          <span class="eff-legend-item">
            <span class="eff-legend-dot" style="background:var(--eff-red)"></span>
            Below Goal
          </span>
        </div>
        <div x-text="'Generated ' + new Date().toISOString().slice(0,10)"></div>
      </div>
    </template>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- EDIT CONSTANTS MODAL                       -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="showConstantsModal" x-cloak class="eff-modal-overlay" @click.self="showConstantsModal = false">
    <div class="eff-modal">
      <div class="eff-modal-header">
        <h3 class="eff-modal-title">Edit Tech Constants</h3>
        <button @click="showConstantsModal = false" class="eff-modal-close">&times;</button>
      </div>
      <table class="eff-modal-table" style="font-size:12px;">
        <thead>
          <tr>
            <th>Name</th>
            <th style="width:70px;">Noon</th>
            <th style="width:70px;">3PM</th>
            <th style="width:110px;">Shift Type</th>
            <th style="width:100px;">Design Type</th>
            <th style="width:40px;"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in constantsData" :key="'ce-'+idx">
            <tr>
              <td><input type="text" x-model="row.Name" class="eff-modal-input"></td>
              <td><input type="text" x-model="row.Noon" class="eff-modal-input" style="text-align:center;"></td>
              <td><input type="text" x-model="row['3PM']" class="eff-modal-input" style="text-align:center;"></td>
              <td>
                <select x-model="row.ShiftType" class="eff-modal-select">
                  <option value="Morning">Morning</option>
                  <option value="Evening">Evening</option>
                  <option value="Outsource">Outsource</option>
                </select>
              </td>
              <td>
                <select x-model="row.DesignType" class="eff-modal-select">
                  <option value="Regular">Regular</option>
                  <option value="Marpe">Marpe</option>
                </select>
              </td>
              <td style="text-align:center;">
                <button @click="constantsData.splice(idx, 1)" style="background:none; border:none; color:var(--eff-red); cursor:pointer; font-size:16px;" title="Remove">&times;</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div class="eff-modal-footer">
        <button @click="constantsData.push({Name:'', Noon:'0', '3PM':'0', ShiftType:'Morning', DesignType:'Regular'})"
                class="eff-modal-btn eff-modal-btn-secondary">+ Add Row</button>
        <button @click="saveConstants()" class="eff-modal-btn eff-modal-btn-primary" :disabled="constantsSaving"
                x-text="constantsSaving ? 'Saving...' : 'Save Constants'"></button>
        <button @click="showConstantsModal = false" class="eff-modal-btn eff-modal-btn-secondary">Cancel</button>
      </div>
      <p x-show="constantsError" x-text="constantsError" class="eff-modal-error"></p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- EDIT EMPLOYEES MODAL                       -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div x-show="showEmployeesModal" x-cloak class="eff-modal-overlay" @click.self="showEmployeesModal = false">
    <div class="eff-modal" style="max-width:1100px;">
      <div class="eff-modal-header">
        <h3 class="eff-modal-title">Edit Employees</h3>
        <button @click="showEmployeesModal = false" class="eff-modal-close">&times;</button>
      </div>
      <div style="margin-bottom:14px;">
        <input type="text" x-model="employeesFilter" placeholder="Filter by name, team, department..."
               class="eff-modal-input" style="max-width:300px;">
      </div>
      <table class="eff-modal-table" style="font-size:11px;">
        <thead>
          <tr>
            <th style="width:55px;">Emp ID</th>
            <th>Last Name</th>
            <th>First Name</th>
            <th>MT Name</th>
            <th>Department</th>
            <th>Gusto Name</th>
            <th style="width:110px;">Team</th>
            <th style="width:55px;">Training</th>
            <th style="width:30px;"></th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in filteredEmployees()" :key="'emp-'+idx">
            <tr>
              <td><input type="text" x-model="row['Employee ID']" class="eff-modal-input" style="text-align:center;"></td>
              <td><input type="text" x-model="row['Last Name']" class="eff-modal-input"></td>
              <td><input type="text" x-model="row['First Name']" class="eff-modal-input"></td>
              <td><input type="text" x-model="row['MT Name']" class="eff-modal-input"></td>
              <td><input type="text" x-model="row.Department" class="eff-modal-input"></td>
              <td><input type="text" x-model="row['Gusto Name']" class="eff-modal-input"></td>
              <td>
                <select x-model="row.Team" class="eff-modal-select">
                  <option value="">â€”</option>
                  <option value="3D Design">3D Design</option>
                  <option value="3D Manufacturing">3D Manufacturing</option>
                  <option value="ACRYLIC">ACRYLIC</option>
                  <option value="Airway">Airway</option>
                  <option value="BAnding">BAnding</option>
                  <option value="BEnding">BEnding</option>
                  <option value="ESSIX">ESSIX</option>
                  <option value="Finishing">Finishing</option>
                  <option value="MF &amp; Marpe">MF &amp; Marpe</option>
                  <option value="QC">QC</option>
                  <option value="Welding">Welding</option>
                  <option value="z_Not On Report">z_Not On Report</option>
                </select>
              </td>
              <td>
                <select x-model="row['Training Plan']" class="eff-modal-select">
                  <option value="0">0</option>
                  <option value="1">1</option>
                </select>
              </td>
              <td style="text-align:center;">
                <button @click="employeesData.splice(employeesData.indexOf(row), 1)" style="background:none; border:none; color:var(--eff-red); cursor:pointer; font-size:16px;" title="Remove">&times;</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div class="eff-modal-footer">
        <button @click="employeesData.push({'Employee ID':'', 'Last Name':'', 'First Name':'', 'MT Name':'', Department:'', 'Gusto Name':'', Team':'z_Not On Report', 'Training Plan':'0'})"
                class="eff-modal-btn eff-modal-btn-secondary">+ Add Row</button>
        <button @click="saveEmployees()" class="eff-modal-btn eff-modal-btn-primary" :disabled="employeesSaving"
                x-text="employeesSaving ? 'Saving...' : 'Save Employees'"></button>
        <button @click="showEmployeesModal = false" class="eff-modal-btn eff-modal-btn-secondary">Cancel</button>
      </div>
      <p x-show="employeesError" x-text="employeesError" class="eff-modal-error"></p>
    </div>
  </div>

</div><!-- end x-data -->

<script>
function efficiencyPage() {
  return {
    activeTab: 'daily',

    // Daily EFF state
    dailyRows: {{ daily_records | tojson }},
    dailyDate: {{ latest_date | tojson }},
    dailySearch: '',
    dailyTeam: '',

    // MM EFF state
    mmRows: {{ agg_records | tojson }},
    mmTeam: '',

    // Midday state
    noonRows: {{ noon_records | tojson }},
    pm3Rows: {{ pm3_records | tojson }},

    // Constants state
    constantsRecords: {{ constants_records | tojson }},
    showConstantsModal: false,
    constantsData: [],
    constantsSaving: false,
    constantsError: '',

    // Employees state
    showEmployeesModal: false,
    employeesData: [],
    employeesSaving: false,
    employeesError: '',
    employeesFilter: '',

    // Upload state
    uploadStatus: '',
    uploadError: false,

    // Efficiency column names for MM
    mmEffCols: {{ mm_eff_cols | tojson }},

    init() {},

    shortName(name) {
      if (!name) return '';
      const parts = name.trim().split(/\s+/);
      if (parts.length < 2) return name;
      return parts[0] + ' ' + parts[parts.length - 1][0] + '.';
    },

    // â”€â”€â”€ NEW HELPER FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Dynamic subtitle for header
    getSubtitleDate() {
      if (this.activeTab === 'daily') {
        return this.dailyDate || 'All Dates';
      } else if (this.activeTab === 'noon') {
        const d = this.noonRows[0]?.Data_Date || new Date().toISOString().slice(0,10);
        return 'Snapshot: ' + d + ' (12:00 PM)';
      } else if (this.activeTab === '3pm') {
        const d = this.pm3Rows[0]?.Data_Date || new Date().toISOString().slice(0,10);
        return 'Snapshot: ' + d + ' (3:00 PM)';
      } else {
        return 'Multi-Period View';
      }
    },

    // 5-tier efficiency classification
    effTierClass(eff) {
      const n = Number(eff) || 0;
      if (n >= 120) return 'great';
      if (n >= 80)  return 'good';
      if (n >= 65)  return 'ok';
      if (n >= 50)  return 'low';
      return 'poor';
    },

    // Sorted teams for bar chart (descending by eff)
    dailySummaryTeamsSorted() {
      return this.dailySummaryTeams().sort((a, b) => b.eff - a.eff);
    },

    // Team average efficiency
    teamAvgEff(rows) {
      if (!rows || rows.length === 0) return 0;
      const sum = rows.reduce((s, r) => s + (Number(r.Efficiency) || 0), 0);
      return sum / rows.length;
    },

    // MM EFF 5-tier color class
    mmEffTierClass(val) {
      if (val === 'x' || val === null || val === undefined) return 'muted-text';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'muted-text';
      const pct = n * 100;
      if (pct >= 120) return 'great';
      if (pct >= 80)  return 'good';
      if (pct >= 65)  return 'ok';
      if (pct >= 50)  return 'low';
      return 'poor';
    },

    // Case goal comparison (returns class name)
    caseGoalClass(actual, goal) {
      if (goal === null || goal === undefined || goal === 'NA' || goal === '') return '';
      const g = Number(goal);
      if (isNaN(g) || g === 0) return '';
      return Number(actual) >= g ? 'eff-great' : 'eff-poor';
    },

    // â”€â”€â”€ Daily EFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    filteredDailyRows() {
      let rows = this.dailyRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.dailyDate) rows = rows.filter(r => String(r.Date || '').startsWith(this.dailyDate));
      if (this.dailyTeam) rows = rows.filter(r => r.Team === this.dailyTeam);
      if (this.dailySearch.trim()) {
        const q = this.dailySearch.trim().toLowerCase();
        rows = rows.filter(r =>
          String(r['MT Name'] || '').toLowerCase().includes(q) ||
          String(r.Team || '').toLowerCase().includes(q)
        );
      }
      return rows;
    },

    dailySummaryAll() {
      const rows = this.filteredDailyRows();
      if (!rows.length) return { date: '', people: 0, eff: 0, cases: 0, tasks: 0, duration: 0, hours: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
      const hours = rows.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
      const eff = hours > 0 ? (duration / hours) * 100 : 0;
      const date = this.dailyDate || (rows[0] ? rows[0].Date : '');
      return { date, people, eff, cases, tasks, duration, hours };
    },

    dailySummaryTeams() {
      const rows = this.filteredDailyRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const cases = tr.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);
        const tasks = tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
        const duration = tr.reduce((s, r) => s + (Number(r.Tasks_Duration_Hours) || 0), 0);
        const hours = tr.reduce((s, r) => s + (Number(r['Work Hours']) || 0), 0);
        const eff = hours > 0 ? (duration / hours) * 100 : 0;
        return { team, people: tr.length, eff, cases, tasks, duration, hours };
      });
    },

    dailyTeamSections() {
      const rows = this.filteredDailyRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0))
      }));
    },

    dailyTrainingRows() {
      return this.filteredDailyRows()
        .filter(r => r['Training Plan'] == 1)
        .sort((a, b) => (Number(b.Efficiency) || 0) - (Number(a.Efficiency) || 0));
    },

    clearDailyFilters() {
      this.dailyDate = {{ latest_date | tojson }};
      this.dailySearch = '';
      this.dailyTeam = '';
    },

    effColor(val) {
      const n = Number(val) || 0;
      if (n >= 80) return 'color: #27AE60;';
      if (n >= 50) return '';
      if (n > 0) return 'color: #C0392B;';
      return 'color: #999;';
    },

    // â”€â”€â”€ MM EFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    filteredMMRows() {
      let rows = this.mmRows.filter(r => r.Team !== 'z_Not On Report');
      if (this.mmTeam) rows = rows.filter(r => r.Team === this.mmTeam);
      return rows;
    },

    mmTeamsSummary() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      const effCols = this.mmEffCols;
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        const summary = { team };
        effCols.forEach(col => {
          // Average non-"x" values
          const vals = tr.map(r => r[col]).filter(v => v !== 'x' && v !== null && v !== undefined && !isNaN(Number(v)));
          summary[col] = vals.length > 0 ? vals.reduce((s, v) => s + Number(v), 0) / vals.length : 'x';
        });
        return summary;
      });
    },

    mmTeamSections() {
      const rows = this.filteredMMRows();
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || 'No Team';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a['MT Name'] || '').localeCompare(String(b['MT Name'] || '')))
      }));
    },

    mmEffColor(val) {
      if (val === 'x' || val === null || val === undefined) return 'color:#999;';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'color:#999;';
      if (n >= 0.80) return 'color:#27AE60;';
      if (n >= 0.50) return '';
      return 'color:#C0392B;';
    },

    formatMmEff(val) {
      if (val === 'x') return '';
      if (val === null || val === undefined || val === 0) return '';
      const n = Number(val);
      if (isNaN(n)) return '';
      return (n * 100).toFixed(0) + '%';
    },

    // â”€â”€â”€ Midday â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    middaySummaryAll(rows) {
      if (!rows.length) return { date: '', people: 0, cases: 0, tasks: 0, duration: 0 };
      const people = rows.length;
      const cases = rows.reduce((s, r) => s + (Number(r.Cases) || 0), 0);
      const tasks = rows.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0);
      const duration = rows.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0);
      const date = (rows[0] && rows[0].Data_Date) ? rows[0].Data_Date : new Date().toISOString().slice(0, 10);
      return { date, people, cases, tasks, duration };
    },

    middaySummaryTeams(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => {
        const tr = teams[team];
        return {
          team,
          people: tr.length,
          cases: tr.reduce((s, r) => s + (Number(r.Cases) || 0), 0),
          tasks: tr.reduce((s, r) => s + (Number(r.Tasks_Completed) || 0), 0),
          duration: tr.reduce((s, r) => s + (Number(r.Total_Duration_Hours) || 0), 0),
        };
      });
    },

    middayTeamSections(rows) {
      const teams = {};
      rows.forEach(r => {
        const t = r.Team || '#N/A';
        if (!teams[t]) teams[t] = [];
        teams[t].push(r);
      });
      return Object.keys(teams).sort().map(team => ({
        team,
        rows: teams[team].sort((a, b) => String(a.Name || '').localeCompare(String(b.Name || '')))
      }));
    },

    // â”€â”€â”€ Goal Color â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    caseGoalColor(actual, goal) {
      if (goal === null || goal === undefined || goal === 'NA' || goal === '') return '';
      const g = Number(goal);
      if (isNaN(g) || g === 0) return '';
      return Number(actual) >= g ? 'color:#27AE60; font-weight:600;' : 'color:#C0392B; font-weight:600;';
    },

    // â”€â”€â”€ Constants Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async openConstantsModal() {
      this.constantsError = '';
      this.constantsSaving = false;
      try {
        const resp = await fetch('/efficiency/constants');
        this.constantsData = await resp.json();
      } catch (e) {
        this.constantsData = JSON.parse(JSON.stringify(this.constantsRecords));
      }
      this.showConstantsModal = true;
    },

    async saveConstants() {
      this.constantsSaving = true;
      this.constantsError = '';
      try {
        const resp = await fetch('/efficiency/constants', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.constantsData),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.showConstantsModal = false;
          setTimeout(() => window.location.reload(), 500);
        } else {
          this.constantsError = data.message || 'Save failed';
        }
      } catch (e) {
        this.constantsError = 'Save failed â€” check console';
      }
      this.constantsSaving = false;
    },

    // â”€â”€â”€ Employees Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    filteredEmployees() {
      if (!this.employeesFilter.trim()) return this.employeesData;
      const q = this.employeesFilter.trim().toLowerCase();
      return this.employeesData.filter(r =>
        Object.values(r).some(v => String(v || '').toLowerCase().includes(q))
      );
    },

    async openEmployeesModal() {
      this.employeesError = '';
      this.employeesSaving = false;
      this.employeesFilter = '';
      try {
        const resp = await fetch('/efficiency/employees');
        this.employeesData = await resp.json();
      } catch (e) {
        this.employeesData = [];
        this.employeesError = 'Failed to load employees';
      }
      this.showEmployeesModal = true;
    },

    async saveEmployees() {
      this.employeesSaving = true;
      this.employeesError = '';
      try {
        const resp = await fetch('/efficiency/employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.employeesData),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.showEmployeesModal = false;
          setTimeout(() => window.location.reload(), 500);
        } else {
          this.employeesError = data.message || 'Save failed';
        }
      } catch (e) {
        this.employeesError = 'Save failed â€” check console';
      }
      this.employeesSaving = false;
    },

    // â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async uploadGusto(event) {
      const file = event.target.files[0];
      if (!file) return;
      this.uploadStatus = 'Uploading...';
      this.uploadError = false;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const resp = await fetch('/efficiency/upload', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Uploaded ${data.date_range} â€” ${data.new_rows} employees processed`;
          this.uploadError = false;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Upload failed â€” check console';
        this.uploadError = true;
      }
      event.target.value = '';
    },

    // â”€â”€â”€ Refresh Midday â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async refreshMidday() {
      this.uploadStatus = 'Refreshing midday data...';
      this.uploadError = false;
      try {
        const resp = await fetch('/efficiency/refresh-midday', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
          this.uploadStatus = `Midday refreshed â€” noon: ${data.rows.noon} rows, 3pm: ${data.rows['3pm']} rows`;
          setTimeout(() => window.location.reload(), 1500);
        } else {
          this.uploadStatus = `Error: ${data.message}`;
          this.uploadError = true;
        }
      } catch (e) {
        this.uploadStatus = 'Refresh failed â€” check console';
        this.uploadError = true;
      }
    },

    // â”€â”€â”€ PDF Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _pdfEffStyle(val) {
      const n = Number(val) || 0;
      const tier = this.effTierClass(n);
      const color = this._pdfColorForTier(tier);
      return `color:${color}; font-weight:600;`;
    },

    _pdfMmEffStyle(val) {
      if (val === 'x' || val === null || val === undefined) return 'color:#999;';
      const n = Number(val);
      if (isNaN(n) || n === 0) return 'color:#999;';
      const pct = n * 100;
      const tier = this.effTierClass(pct);
      const color = this._pdfColorForTier(tier);
      return `color:${color}; font-weight:600;`;
    },

    _pdfEffCell(val) {
      if (!val || val <= 0) return '';
      const pct = val.toFixed(0);
      return `<span style="${this._pdfEffStyle(val)}">${pct}%</span>`;
    },

    _pdfMmEffCell(val) {
      const text = this.formatMmEff(val);
      return `<span style="${this._pdfMmEffStyle(val)}">${text}</span>`;
    },

    // â”€â”€â”€ PDF Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async exportPdf() {
      const tabNames = { daily: 'Daily_EFF', mm: 'MM_EFF', noon: 'Noon_EFF', '3pm': '3PM_EFF' };
      const tabLabel = tabNames[this.activeTab] || 'Efficiency';
      const today = new Date().toISOString().slice(0, 10);

      // Determine report date from data (not today)
      let reportDate = today;
      if (this.activeTab === 'daily') {
        reportDate = this.dailySummaryAll().date || today;
      } else if (this.activeTab === 'noon' || this.activeTab === '3pm') {
        const src = this.activeTab === 'noon' ? this.noonRows : this.pm3Rows;
        reportDate = this.middaySummaryAll(src).date || today;
      }

      const filename = `Efficiency_${tabLabel}_${reportDate}.pdf`;

      // Load logo as base64
      let logoBase64 = '';
      try {
        const resp = await fetch('/static/logo.png');
        const blob = await resp.blob();
        logoBase64 = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (e) { /* logo optional */ }

      let html = `<div style="font-family:Arial,sans-serif; padding:8px;">`;

      // Logo + header
      if (logoBase64) {
        html += `<div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">`;
        html += `<img src="${logoBase64}" style="max-height:40px;">`;
        html += `<h2 style="margin:0; color:#000; font-size:14px;">${tabLabel.replace(/_/g,' ')} â€” ${reportDate}</h2>`;
        html += `</div>`;
      } else {
        html += `<h2 style="margin:0 0 8px; color:#000; font-size:14px;">${tabLabel.replace(/_/g,' ')} â€” ${reportDate}</h2>`;
      }

      if (this.activeTab === 'daily') {
        const summary = this.dailySummaryAll();

        // ALL table (full-width)
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">ALL</p>`;
        html += this._pdfTable(
          ['Date','People','EFF','Cases','Tasks','Duration','Work Hrs'],
          [[summary.date, summary.people, this._pdfEffCell(summary.eff), summary.cases, summary.tasks, summary.duration.toFixed(1), summary.hours.toFixed(1)]]
        );

        // Teams table (full-width)
        html += `<p style="margin:8px 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams</p>`;
        const teamRows = this.dailySummaryTeams().map(ts => [
          ts.team, ts.people, this._pdfEffCell(ts.eff), ts.cases, ts.tasks, ts.duration.toFixed(1), ts.hours.toFixed(1)
        ]);
        html += this._pdfTable(['Group','People','EFF','Cases','Tasks','Duration','Work Hrs'], teamRows);

        // Per-team (2-column grid)
        const sections = this.dailyTeamSections();
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px;">`;
        sections.forEach(sec => {
          html += `<div style="page-break-inside:avoid;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [
            this.shortName(r['MT Name']), this._pdfEffCell(r.Efficiency),
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Name','EFF','Cases','Tasks','Duration','Work Hrs'], rows);
          html += `</div>`;
        });
        html += `</div>`;

        // Training (half-width)
        const trainRows = this.dailyTrainingRows();
        if (trainRows.length) {
          html += `<div style="max-width:50%; margin-top:6px;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">Training</p>`;
          const rows = trainRows.map(r => [
            this.shortName(r['MT Name']), this._pdfEffCell(r.Efficiency),
            r.Cases_Worked_On || 0, r.Tasks_Completed || 0,
            (r.Tasks_Duration_Hours || 0).toFixed(1), (r['Work Hours'] || 0).toFixed(1)
          ]);
          html += this._pdfTable(['Name','EFF','Cases','Tasks','Duration','Work Hrs'], rows);
          html += `</div>`;
        }

      } else if (this.activeTab === 'mm') {
        const effCols = this.mmEffCols;
        const headers = ['Teams', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];

        // Teams summary (full-width)
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams Summary</p>`;
        const teamRows = this.mmTeamsSummary().map(ts => [ts.team, ...effCols.map(c => this._pdfMmEffCell(ts[c]))]);
        html += this._pdfMmTable(headers, teamRows);

        // Per-team (single column, full-width for many columns)
        const detailHeaders = ['Name', ...effCols.map(c => c.replace('Efficiency_','').replace(/_/g,' '))];
        const sections = this.mmTeamSections();
        sections.forEach(sec => {
          html += `<div style="margin-top:4px;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => [this.shortName(r['MT Name']), ...effCols.map(c => this._pdfMmEffCell(r[c]))]);
          html += this._pdfMmTable(detailHeaders, rows);
          html += `</div>`;
        });

      } else {
        const isNoon = this.activeTab === 'noon';
        const src = isNoon ? this.noonRows : this.pm3Rows;
        const label = isNoon ? '12:00 PM' : '3:00 PM';
        const goalKey = isNoon ? 'Noon_Goal' : 'PM3_Goal';

        const summary = this.middaySummaryAll(src);

        // ALL table (full-width)
        html += `<p style="margin:0 0 2px; font-weight:700; font-size:9px; color:#C00;">ALL â€” ${label} Snapshot</p>`;
        html += this._pdfTable(
          ['Date','People','Cases','Tasks','Duration'],
          [[summary.date, summary.people, summary.cases, summary.tasks, summary.duration.toFixed(1)]]
        );

        // Teams table (full-width)
        html += `<p style="margin:8px 0 2px; font-weight:700; font-size:9px; color:#C00;">Teams</p>`;
        const teamRows = this.middaySummaryTeams(src).map(ts => [ts.team, ts.people, ts.cases, ts.tasks, ts.duration.toFixed(1)]);
        html += this._pdfTable(['Team/Group','People','Cases','Tasks','Duration'], teamRows);

        // Per-team (2-column grid)
        const sections = this.middayTeamSections(src);
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px;">`;
        sections.forEach(sec => {
          html += `<div style="page-break-inside:avoid;">`;
          html += `<p style="margin:0 0 2px; font-weight:700; font-size:8px; color:#C00;">${sec.team}</p>`;
          const rows = sec.rows.map(r => {
            const cases = r.Cases || 0;
            const goal = r[goalKey];
            let casesCell = String(cases);
            if (goal !== null && goal !== undefined && goal !== 'NA' && goal !== '' && !isNaN(Number(goal)) && Number(goal) > 0) {
              const color = Number(cases) >= Number(goal) ? '#27AE60' : '#C0392B';
              casesCell = `<span style="color:${color}; font-weight:600;">${cases}</span>`;
            }
            return [this.shortName(r.Name), casesCell, r.Tasks_Completed || 0, (r.Total_Duration_Hours || 0).toFixed(1)];
          });
          html += this._pdfTable(['Name','Cases','Tasks','Duration'], rows);
          html += `</div>`;
        });
        html += `</div>`;
      }

      html += `</div>`;

      const opt = {
        margin: [5, 5, 5, 5],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: this.activeTab === 'mm' ? 1.5 : 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'landscape' },
        pagebreak: { mode: this.activeTab === 'mm' ? ['css', 'legacy'] : ['avoid-all', 'css', 'legacy'] },
      };

      const el = document.createElement('div');
      el.innerHTML = html;
      document.body.appendChild(el);
      html2pdf().set(opt).from(el).save().then(() => {
        document.body.removeChild(el);
      });
    },

    _pdfColorForTier(tier) {
      const colors = {
        'great': '#22c55e',      // â‰¥120% - green
        'good': '#86efac',       // 100-119% - light green
        'ok': '#eab308',         // 85-99% - yellow
        'low': '#f97316',        // 70-84% - orange
        'poor': '#ef4444',       // <70% - red
      };
      return colors[tier] || '#000';
    },

    _pdfTable(headers, rows) {
      let h = `<table style="width:100%; border-collapse:collapse; font-size:7px; margin-bottom:3px; page-break-inside:avoid;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        const nowrap = idx === 0 ? 'white-space:nowrap;' : '';
        h += `<th style="border:1px solid #333; background:#C00; color:#fff; padding:1px 2px; text-align:${align}; ${nowrap} font-size:6px;">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f2f2f2';
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const nowrap = idx === 0 ? 'white-space:nowrap;' : '';
          h += `<td style="border:1px solid #999; padding:1px 2px; background:${bg}; font-size:7px; text-align:${align}; ${nowrap}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    _pdfMmTable(headers, rows) {
      let h = `<table style="width:100%; border-collapse:collapse; font-size:5px; margin-bottom:3px; table-layout:fixed;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        const w = idx === 0 ? 'width:90px;' : '';
        h += `<th style="border:1px solid #333; background:#C00; color:#fff; padding:1px 1px; text-align:${align}; font-size:5px; overflow:hidden; ${w}">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const bg = i % 2 === 0 ? '#fff' : '#f2f2f2';
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const nowrap = idx === 0 ? 'white-space:nowrap; overflow:hidden;' : '';
          h += `<td style="border:1px solid #999; padding:1px 1px; background:${bg}; font-size:5px; text-align:${align}; ${nowrap}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    // â”€â”€â”€ 3D Design PDF (Larry_ex format) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _larryCell(actual, goal) {
      // Actual cell with red/green background based on goal
      if (goal === 'NA' || goal === null || goal === undefined || goal === '') return 'NA';
      const a = Number(actual) || 0;
      const g = Number(goal);
      if (isNaN(g)) return String(a);
      const bg = a >= g ? '#00B050' : '#FF0000';
      return `<span style="background:${bg}; color:#fff; padding:1px 4px; font-weight:600;">${a}</span>`;
    },

    _larryTable(headers, rows, opts = {}) {
      const headerBg = opts.headerBg || '#D9D2E9';
      let h = `<table style="width:100%; border-collapse:collapse; font-size:10px; margin-bottom:6px;">`;
      h += `<thead><tr>`;
      headers.forEach((hdr, idx) => {
        const align = idx === 0 ? 'left' : 'center';
        h += `<th style="border:1px solid #999; background:${headerBg}; padding:3px 6px; text-align:${align}; font-size:10px; font-weight:600;">${hdr}</th>`;
      });
      h += `</tr></thead><tbody>`;
      rows.forEach((cells, i) => {
        const isTotalRow = opts.totalRowIdx === i;
        h += `<tr>`;
        cells.forEach((c, idx) => {
          const align = idx === 0 ? 'left' : 'center';
          const fw = isTotalRow ? 'font-weight:700;' : '';
          h += `<td style="border:1px solid #ddd; padding:2px 6px; background:#fff; font-size:10px; text-align:${align}; ${fw}">${c}</td>`;
        });
        h += `</tr>`;
      });
      h += `</tbody></table>`;
      return h;
    },

    async export3dDesignPdf() {
      const isNoon = this.activeTab === 'noon';
      const constants = this.constantsRecords;

      // Build lookup: name -> constant row
      const constMap = {};
      constants.forEach(c => {
        const key = c.Name + '|' + (c.ShiftType || 'Morning');
        constMap[key] = c;
      });

      // Build actual data lookup from noon/3pm rows
      const noonMap = {};
      this.noonRows.forEach(r => { noonMap[r.Name] = r; });
      const pm3Map = {};
      this.pm3Rows.forEach(r => { pm3Map[r.Name] = r; });

      // Get data date
      const dataDate = this.middaySummaryAll(isNoon ? this.noonRows : this.pm3Rows).date;
      const d = new Date(dataDate + 'T00:00:00');
      const dateStr = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(2)}`;

      // Group constants by ShiftType
      const morning = constants.filter(c => c.ShiftType === 'Morning');
      const evening = constants.filter(c => c.ShiftType === 'Evening');
      const outsource = constants.filter(c => c.ShiftType === 'Outsource');

      let html = `<div style="font-family:Arial,sans-serif; padding:12px;">`;
      html += `<p style="margin:0 0 2px; font-size:12px;"><strong>DATE:</strong> &nbsp; ${dateStr}</p>`;
      html += `<p style="margin:0 0 8px; font-size:12px; font-weight:600;">Morning shift</p>`;

      // Morning shift table
      let mHeaders, mRows;
      if (isNoon) {
        mHeaders = ['Designer', 'By 12 PM', '12:00 PM', 'Notes'];
        mRows = morning.map(c => {
          const actual = noonMap[c.Name];
          const noonGoal = c.Noon;
          const noonActual = actual ? actual.Cases : null;
          return [
            this.shortName(c.Name),
            noonGoal === 'NA' ? 'NA' : noonGoal,
            this._larryCell(noonActual, noonGoal),
            '',
          ];
        });
        // Total row
        const totalNoonGoal = morning.reduce((s, c) => c.Noon !== 'NA' ? s + (Number(c.Noon) || 0) : s, 0);
        const totalNoonActual = morning.reduce((s, c) => {
          const a = noonMap[c.Name];
          return a && c.Noon !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        mRows.push([
          '<strong>Total made by this time:</strong>',
          totalNoonGoal,
          this._larryCell(totalNoonActual, totalNoonGoal),
          '',
        ]);
      } else {
        mHeaders = ['Designer', 'By 12 PM', '12:00 PM', 'By 3 PM', '3:00 PM', 'Notes'];
        mRows = morning.map(c => {
          const noonActualRow = noonMap[c.Name];
          const pm3ActualRow = pm3Map[c.Name];
          const noonGoal = c.Noon;
          const pm3Goal = c['3PM'];
          const noonActual = noonActualRow ? noonActualRow.Cases : null;
          const pm3Actual = pm3ActualRow ? pm3ActualRow.Cases : null;
          return [
            this.shortName(c.Name),
            noonGoal === 'NA' ? 'NA' : noonGoal,
            this._larryCell(noonActual, noonGoal),
            pm3Goal === 'NA' ? 'NA' : pm3Goal,
            this._larryCell(pm3Actual, pm3Goal),
            '',
          ];
        });
        // Total row
        const totalNoonGoal = morning.reduce((s, c) => c.Noon !== 'NA' ? s + (Number(c.Noon) || 0) : s, 0);
        const totalNoonActual = morning.reduce((s, c) => {
          const a = noonMap[c.Name];
          return a && c.Noon !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        const totalPm3Goal = morning.reduce((s, c) => c['3PM'] !== 'NA' ? s + (Number(c['3PM']) || 0) : s, 0);
        const totalPm3Actual = morning.reduce((s, c) => {
          const a = pm3Map[c.Name];
          return a && c['3PM'] !== 'NA' ? s + (Number(a.Cases) || 0) : s;
        }, 0);
        mRows.push([
          '<strong>Total made by this time:</strong>',
          totalNoonGoal,
          this._larryCell(totalNoonActual, totalNoonGoal),
          totalPm3Goal,
          this._larryCell(totalPm3Actual, totalPm3Goal),
          '',
        ]);
      }
      html += this._larryTable(mHeaders, mRows, { totalRowIdx: mRows.length - 1 });

      // Evening Shift
      if (evening.length) {
        html += `<p style="margin:12px 0 2px; font-size:12px; font-weight:600;">Evening Shift</p>`;
        const eHeaders = ['Designer', 'Capacity', 'Made', 'Notes'];
        const eRows = evening.map(c => {
          const actual = pm3Map[c.Name] || noonMap[c.Name];
          const capacity = c['3PM'] === 'NA' ? 'NA' : c['3PM'];
          const made = actual ? actual.Cases : 0;
          return [this.shortName(c.Name), capacity, this._larryCell(made, capacity), ''];
        });
        html += this._larryTable(eHeaders, eRows, { headerBg: '#D9D2E9' });
      }

      // Outsource
      if (outsource.length) {
        html += `<p style="margin:12px 0 2px; font-size:12px; font-weight:600;">Outsource</p>`;
        const oHeaders = ['Designer', 'Capacity', 'Made', 'Notes'];
        const oRows = outsource.map(c => {
          const actual = pm3Map[c.Name] || noonMap[c.Name];
          const capacity = c['3PM'] === 'NA' ? 'NA' : c['3PM'];
          const made = actual ? actual.Cases : 0;
          return [this.shortName(c.Name), capacity, this._larryCell(made, capacity), ''];
        });
        html += this._larryTable(oHeaders, oRows, { headerBg: '#D9D2E9' });
      }

      // Yesterday totals from Daily EFF data
      const dailyRows = this.dailyRows.filter(r => r.Team !== 'z_Not On Report');
      if (dailyRows.length) {
        // Get latest date
        const dates = [...new Set(dailyRows.map(r => String(r.Date || '')))].sort().reverse();
        const latestDate = dates[0];
        const yesterdayRows = dailyRows.filter(r => String(r.Date || '').startsWith(latestDate));

        // Match by MT Name to constants Name
        const constNames = new Set(constants.map(c => c.Name));
        const matchedRows = yesterdayRows.filter(r => constNames.has(r['MT Name']));

        const totalParts = matchedRows.reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);

        // Total MARPEs: only DesignType=Marpe employees
        const marpeNames = new Set(constants.filter(c => c.DesignType === 'Marpe').map(c => c.Name));
        const totalMarpes = yesterdayRows
          .filter(r => marpeNames.has(r['MT Name']))
          .reduce((s, r) => s + (Number(r.Cases_Worked_On) || 0), 0);

        html += `<p style="margin:16px 0 2px; font-size:11px;"><strong>Total parts made from yesterday:</strong> &nbsp; ${totalParts}</p>`;
        html += `<p style="margin:2px 0; font-size:11px;"><strong>Total MARPEs made from yesterday:</strong> &nbsp; ${totalMarpes}</p>`;
      }

      html += `</div>`;

      const opt = {
        margin: [8, 8, 8, 8],
        filename: `3D_Design_Report_${dataDate}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      };

      const el = document.createElement('div');
      el.innerHTML = html;
      document.body.appendChild(el);
      html2pdf().set(opt).from(el).save().then(() => {
        document.body.removeChild(el);
      });
    },
  };
}
</script>
{% endblock %}
