{% extends "base.html" %}
{% block title %}Case Locations{% endblock %}

{% block content %}
<div x-data="{ activeFilter: null, selectedLocation: '', selectedCategory: '', selectedShipDate: '' }">

  <!-- Filter Bar -->
  <div class="page-header">
    <div class="filter-bar">
      <button class="btn btn-rush"
              :class="{ active: activeFilter === 'rush' }"
              @click="activeFilter = activeFilter === 'rush' ? null : 'rush'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Rush
      </button>
      <button class="btn btn-overdue"
              :class="{ active: activeFilter === 'overdue' }"
              @click="activeFilter = activeFilter === 'overdue' ? null : 'overdue'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Overdue
      </button>
      <button class="btn btn-leaves"
              :class="{ active: activeFilter === 'leaves_today' }"
              @click="activeFilter = activeFilter === 'leaves_today' ? null : 'leaves_today'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Leaves Today
      </button>
      <button class="btn btn-view-all"
              :class="{ active: activeFilter === null }"
              @click="activeFilter = null; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        View All
      </button>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedCategory"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Categories</option>
        {% for cat in all_categories %}
        <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedLocation"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Locations</option>
        {% for loc in all_locations %}
        <option value="{{ loc }}">{{ loc }}</option>
        {% endfor %}
      </select>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedShipDate"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Ship Dates</option>
        {% for sd in all_ship_dates %}
        <option value="{{ sd }}">{{ sd }}</option>
        {% endfor %}
      </select>

      <button class="btn btn-reset"
              x-show="activeFilter || selectedCategory || selectedLocation || selectedShipDate"
              x-transition
              @click="activeFilter = null; selectedCategory = ''; selectedLocation = ''; selectedShipDate = ''; document.querySelector('[name=search]').value = ''; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        Reset Filters
      </button>
    </div>
    <div class="total-badge"
         hx-get="/partials/total-cases-badge"
         hx-trigger="sse:data-refreshed, filter-changed from:body"
         hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']"
         hx-swap="innerHTML">
      <span class="total-badge-count">{{ total_cases }}</span>
      <span class="total-badge-label">Total Cases</span>
    </div>
  </div>

  <!-- Split Layout -->
  <div class="split-layout">
    <!-- Left: Location Grid -->
    <div class="split-left">
      <div id="location-grid"
           hx-get="/partials/location-grid"
           hx-trigger="sse:data-refreshed, filter-changed"
           hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']"
           hx-swap="innerHTML">
        {% include "partials/location_grid.html" %}
      </div>
    </div>

    <!-- Right: Data Table -->
    <div class="split-right">
      <div class="table-container">
        <div class="table-header-bar">
          <input type="search" class="search-input" placeholder="Case #"
                 name="search"
                 hx-get="/partials/case-table"
                 hx-trigger="keyup changed delay:300ms"
                 hx-target="#case-table-content"
                 hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']">
          <a class="btn btn-view-all"
             :href="'/partials/export-csv?' + new URLSearchParams({filter: activeFilter || '', search: document.querySelector('[name=search]')?.value || '', location: selectedLocation || '', category: selectedCategory || '', ship_date: selectedShipDate || ''}).toString()"
             download="case_locations.csv"
             style="text-decoration:none; vertical-align:middle;">
            Export CSV
          </a>
          <button class="btn btn-view-all" @click="exportTilesPDF()" style="vertical-align:middle;">
            Export PDF
          </button>
          <input type="hidden" name="filter" :value="activeFilter || ''">
          <input type="hidden" name="category" :value="selectedCategory || ''">
          <input type="hidden" name="location" :value="selectedLocation || ''">
          <input type="hidden" name="ship_date" :value="selectedShipDate || ''">
        </div>

        <div id="case-table-content"
             hx-get="/partials/case-table"
             hx-trigger="sse:data-refreshed, filter-changed"
             hx-include="[name='filter'],[name='search'],[name='location'],[name='category'],[name='ship_date']"
             hx-swap="innerHTML">
          {% include "partials/case_table.html" %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportTilesPDF() {
  // Build filter label
  var filters = [];
  var alpineData = Alpine.$data(document.querySelector('[x-data]'));
  if (alpineData.activeFilter) {
    var labels = {rush: 'Rush', overdue: 'Overdue', leaves_today: 'Leaves Today'};
    filters.push(labels[alpineData.activeFilter] || alpineData.activeFilter);
  }
  if (alpineData.selectedCategory) filters.push('Category: ' + alpineData.selectedCategory);
  if (alpineData.selectedLocation) filters.push('Location: ' + alpineData.selectedLocation);
  if (alpineData.selectedShipDate) filters.push('Ship Date: ' + alpineData.selectedShipDate);
  var filterText = filters.length ? filters.join('  |  ') : 'All Cases';

  // Create a wrapper div for PDF content
  var wrapper = document.createElement('div');
  wrapper.style.cssText = 'background:#fff; padding:24px; width:900px;';

  // Logo
  var logo = document.createElement('img');
  logo.src = '/static/logo.png';
  logo.style.cssText = 'height:50px; display:block; margin-bottom:8px;';
  wrapper.appendChild(logo);

  // Date
  var dateLine = document.createElement('div');
  dateLine.style.cssText = 'font-size:13px; color:#666; margin-bottom:4px; font-family:sans-serif;';
  dateLine.textContent = new Date().toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  wrapper.appendChild(dateLine);

  // Filter label
  var filterLine = document.createElement('div');
  filterLine.style.cssText = 'font-size:14px; font-weight:600; color:#333; margin-bottom:16px; font-family:sans-serif; padding-bottom:12px; border-bottom:2px solid #e53935;';
  filterLine.textContent = filterText;
  wrapper.appendChild(filterLine);

  // Clone the location grid
  var grid = document.getElementById('location-grid');
  var gridClone = grid.cloneNode(true);
  gridClone.style.cssText = '';
  // Remove Alpine click handlers from clone
  gridClone.querySelectorAll('[\\@click], [\\@click\\.stop]').forEach(function(el) {
    el.removeAttribute('@click');
    el.removeAttribute('@click.stop');
    el.style.cursor = 'default';
  });
  wrapper.appendChild(gridClone);

  // Temporarily add to DOM (offscreen) for html2pdf to render
  wrapper.style.position = 'fixed';
  wrapper.style.left = '-9999px';
  wrapper.style.top = '0';
  document.body.appendChild(wrapper);

  // Wait for logo to load, then generate PDF
  logo.onload = function() { generatePDF(); };
  logo.onerror = function() { generatePDF(); };
  if (logo.complete) generatePDF();

  var generated = false;
  function generatePDF() {
    if (generated) return;
    generated = true;

    html2pdf().set({
      margin: [10, 10, 10, 10],
      filename: 'case_locations_tiles.pdf',
      image: {type: 'png', quality: 1},
      html2canvas: {scale: 2, useCORS: true, backgroundColor: '#ffffff'},
      jsPDF: {unit: 'mm', format: 'letter', orientation: 'portrait'},
      pagebreak: {mode: ['avoid-all']}
    }).from(wrapper).save().then(function() {
      document.body.removeChild(wrapper);
    });
  }
}
</script>
{% endblock %}
