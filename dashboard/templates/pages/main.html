{% extends "base.html" %}
{% block title %}Case Locations{% endblock %}

{% block content %}
<div x-data="{ activeFilter: null, selectedLocation: '', selectedCategory: '', selectedShipDate: '' }">

  <!-- Filter Bar -->
  <div class="page-header">
    <div class="filter-bar">
      <button class="btn btn-rush"
              :class="{ active: activeFilter === 'rush' }"
              @click="activeFilter = activeFilter === 'rush' ? null : 'rush'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Rush
      </button>
      <button class="btn btn-overdue"
              :class="{ active: activeFilter === 'overdue' }"
              @click="activeFilter = activeFilter === 'overdue' ? null : 'overdue'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Overdue
      </button>
      <button class="btn btn-leaves"
              :class="{ active: activeFilter === 'leaves_today' }"
              @click="activeFilter = activeFilter === 'leaves_today' ? null : 'leaves_today'; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        Leaves Today
      </button>
      <button class="btn btn-view-all"
              :class="{ active: activeFilter === null }"
              @click="activeFilter = null; $nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })"
              >
        View All
      </button>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedCategory"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Categories</option>
        {% for cat in all_categories %}
        <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedLocation"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Locations</option>
        {% for loc in all_locations %}
        <option value="{{ loc }}">{{ loc }}</option>
        {% endfor %}
      </select>

      <span style="display:inline-block; width:1px; height:28px; background:#e53935; margin:0 12px; vertical-align:middle;"></span>

      <select class="filter-select" style="height:36px; vertical-align:middle;"
              x-model="selectedShipDate"
              @change="$nextTick(() => { htmx.trigger('#case-table-content', 'filter-changed'); htmx.trigger('#location-grid', 'filter-changed'); })">
        <option value="">All Ship Dates</option>
        {% for sd in all_ship_dates %}
        <option value="{{ sd }}">{{ sd }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="total-badge"
         hx-get="/partials/total-cases-badge"
         hx-trigger="sse:data-refreshed, filter-changed from:body"
         hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']"
         hx-swap="innerHTML">
      <span class="total-badge-count">{{ total_cases }}</span>
      <span class="total-badge-label">Total Cases</span>
    </div>
  </div>

  <!-- Split Layout -->
  <div class="split-layout">
    <!-- Left: Location Grid -->
    <div class="split-left">
      <div id="location-grid"
           hx-get="/partials/location-grid"
           hx-trigger="sse:data-refreshed, filter-changed"
           hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']"
           hx-swap="innerHTML">
        {% include "partials/location_grid.html" %}
      </div>
    </div>

    <!-- Right: Data Table -->
    <div class="split-right">
      <div class="table-container">
        <div class="table-header-bar">
          <input type="search" class="search-input" placeholder="Case #"
                 name="search"
                 hx-get="/partials/case-table"
                 hx-trigger="keyup changed delay:300ms"
                 hx-target="#case-table-content"
                 hx-include="[name='filter'],[name='location'],[name='category'],[name='ship_date']">
          <a class="btn btn-view-all"
             :href="'/partials/export-csv?' + new URLSearchParams({filter: activeFilter || '', search: document.querySelector('[name=search]')?.value || '', location: selectedLocation || '', category: selectedCategory || '', ship_date: selectedShipDate || ''}).toString()"
             download="case_locations.csv"
             style="text-decoration:none; vertical-align:middle;">
            Export CSV
          </a>
          <input type="hidden" name="filter" :value="activeFilter || ''">
          <input type="hidden" name="category" :value="selectedCategory || ''">
          <input type="hidden" name="location" :value="selectedLocation || ''">
          <input type="hidden" name="ship_date" :value="selectedShipDate || ''">
        </div>

        <div id="case-table-content"
             hx-get="/partials/case-table"
             hx-trigger="sse:data-refreshed, filter-changed"
             hx-include="[name='filter'],[name='search'],[name='location'],[name='category'],[name='ship_date']"
             hx-swap="innerHTML">
          {% include "partials/case_table.html" %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
