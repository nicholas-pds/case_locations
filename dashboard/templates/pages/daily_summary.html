{% extends "base.html" %}
{% block title %}Daily Summary{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
  if (typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
  }

  document.addEventListener('DOMContentLoaded', function() {
    const salesData = {{ sales_history_json | safe }};

    // Revenue Chart
    const revenueCtx = document.getElementById('salesRevenueChart');
    if (revenueCtx && salesData.length) {
      new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: salesData.map(d => d.label),
          datasets: [{
            label: 'Revenue',
            data: salesData.map(d => d.subtotal),
            backgroundColor: '#27AE60',
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#FFFFFF',
              font: { family: 'Inter', size: 12, weight: '700' },
              anchor: 'center',
              align: 'center',
              display: function(context) {
                return context.dataset.data[context.dataIndex] > 0;
              },
              formatter: function(value) {
                return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
              }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { family: 'Inter', size: 11 } } },
            y: {
              beginAtZero: true,
              grid: { color: '#F0F0F0' },
              ticks: {
                font: { family: 'Inter', size: 11 },
                callback: function(value) { return '$' + value.toLocaleString(); }
              }
            }
          }
        }
      });
    }

    // Case Count Chart
    const countCtx = document.getElementById('salesCountChart');
    if (countCtx && salesData.length) {
      new Chart(countCtx, {
        type: 'bar',
        data: {
          labels: salesData.map(d => d.label),
          datasets: [{
            label: 'Invoice Count',
            data: salesData.map(d => d.count),
            backgroundColor: '#2196F3',
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#FFFFFF',
              font: { family: 'Inter', size: 13, weight: '700' },
              anchor: 'center',
              align: 'center',
              display: function(context) {
                return context.dataset.data[context.dataIndex] > 0;
              },
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { family: 'Inter', size: 11 } } },
            y: { beginAtZero: true, grid: { color: '#F0F0F0' }, ticks: { font: { family: 'Inter', size: 11 } } }
          }
        }
      });
    }

    // Total Cases by Day (stacked bar)
    const workloadData = {{ workload_chart_json | safe }};
    const totalCtx = document.getElementById('totalCasesChart');
    if (totalCtx && workloadData.labels && workloadData.labels.length) {
      new Chart(totalCtx, {
        type: 'bar',
        data: {
          labels: workloadData.labels,
          datasets: [
            {
              label: 'Invoiced',
              data: workloadData.invoiced,
              backgroundColor: '#27AE60',
              borderRadius: 4,
            },
            {
              label: 'In Production',
              data: workloadData.in_production,
              backgroundColor: '#2196F3',
              borderRadius: 4,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { font: { family: 'Inter', size: 11 }, usePointStyle: true, pointStyle: 'rect' }
            },
            datalabels: {
              color: '#FFFFFF',
              font: { family: 'Inter', size: 11, weight: '700' },
              anchor: 'center',
              align: 'center',
              display: function(context) {
                return context.dataset.data[context.dataIndex] > 0;
              },
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false }, ticks: { font: { family: 'Inter', size: 11 } } },
            y: { stacked: true, beginAtZero: true, grid: { color: '#F0F0F0' }, ticks: { font: { family: 'Inter', size: 11 } } }
          }
        }
      });
    }

    // Pace Horizontal Bar Chart
    const paceData = {{ pace_data | tojson }};
    const paceCtx = document.getElementById('paceBarChart');
    if (paceCtx && paceData.length) {
      new Chart(paceCtx, {
        type: 'bar',
        data: {
          labels: paceData.map(d => d.label),
          datasets: [{
            data: paceData.map(d => d.pct),
            backgroundColor: paceData.map(d => d.status === 'ahead' ? '#27AE60' : '#E74C3C'),
            borderRadius: 4,
            barPercentage: 0.7,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#FFFFFF',
              font: { family: 'Inter', size: 12, weight: '700' },
              anchor: 'center',
              align: 'center',
              display: function(context) {
                return context.dataset.data[context.dataIndex] > 0;
              },
              formatter: function(value) {
                return Math.round(value) + '%';
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#F0F0F0' },
              ticks: {
                font: { family: 'Inter', size: 11 },
                callback: function(value) { return value + '%'; }
              }
            },
            y: {
              display: false,
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Daily Summary</h1>
</div>

<!-- Top metric cards -->
<div class="summary-cards">
  <div class="summary-card summary-card-submitted">
    <div class="summary-label">Cases Submitted</div>
    <div class="summary-value">{{ submitted_count }}</div>
  </div>
  <div class="summary-card summary-card-production">
    <div class="summary-label">In Production</div>
    <div class="summary-value">{{ total_in_production }}</div>
  </div>
  <div class="summary-card summary-card-airway">
    <div class="summary-label">Airway Planning</div>
    <div class="summary-value">{{ airway_planning_count }}</div>
  </div>
</div>

<!-- Two-column layout -->
<div class="daily-layout">
  <!-- LEFT COLUMN: Charts stacked -->
  <div>
    {% if sales_history %}
    <div class="chart-container">
      <h3 class="chart-section-title">Previous 5 Business Days &mdash; Revenue</h3>
      <canvas id="salesRevenueChart" style="max-height:250px;"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 0;">
      <h3 class="chart-section-title">Previous 5 Business Days &mdash; Case Count</h3>
      <canvas id="salesCountChart" style="max-height:250px;"></canvas>
    </div>
    {% else %}
    <div class="chart-container">
      <div class="empty-state">
        <p>No sales history data available</p>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- RIGHT COLUMN: Pace tiles + horizontal bar chart -->
  <div>
    <div class="pace-chart-split">
      <!-- Pace tiles stacked vertically -->
      <div class="pace-stack">
        {% include "partials/workload_pace.html" %}
      </div>

      <!-- Horizontal bar chart aligned with tiles -->
      <div class="chart-container" style="margin-bottom: 0; display: flex; align-items: stretch;">
        <canvas id="paceBarChart"></canvas>
      </div>
    </div>

    <!-- Total Cases by Day (stacked: invoiced + in production) -->
    <div class="chart-container" style="margin-top: 24px;">
      <h3 class="chart-section-title">Total Cases by Day &mdash; Invoiced + In Production</h3>
      <canvas id="totalCasesChart" style="max-height:280px;"></canvas>
    </div>
  </div>
</div>
{% endblock %}
